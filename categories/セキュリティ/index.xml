<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>セキュリティ on firebirdテクテクテクブログ</title><link>https://firebird-techtalktech.com/categories/%E3%82%BB%E3%82%AD%E3%83%A5%E3%83%AA%E3%83%86%E3%82%A3/</link><description>Recent content in セキュリティ on firebirdテクテクテクブログ</description><generator>Hugo -- gohugo.io</generator><language>ja</language><copyright>トミー</copyright><lastBuildDate>Sun, 14 Sep 2025 15:00:00 +0900</lastBuildDate><atom:link href="https://firebird-techtalktech.com/categories/%E3%82%BB%E3%82%AD%E3%83%A5%E3%83%AA%E3%83%86%E3%82%A3/index.xml" rel="self" type="application/rss+xml"/><item><title>【社内ネットワーク全滅】境界防御を過信した結果、攻撃者に内部侵入を許した5日間の悪夢</title><link>https://firebird-techtalktech.com/post/%E7%A4%BE%E5%86%85%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF%E5%85%A8%E6%BB%85%E5%A2%83%E7%95%8C%E9%98%B2%E5%BE%A1%E3%82%92%E9%81%8E%E4%BF%A1%E3%81%97%E3%81%9F%E7%B5%90%E6%9E%9C%E6%94%BB%E6%92%83%E8%80%85%E3%81%AB%E5%86%85%E9%83%A8%E4%BE%B5%E5%85%A5%E3%82%92%E8%A8%B1%E3%81%97%E3%81%9F5%E6%97%A5%E9%96%93%E3%81%AE%E6%82%AA%E5%A4%A2/</link><pubDate>Sun, 14 Sep 2025 15:00:00 +0900</pubDate><guid>https://firebird-techtalktech.com/post/%E7%A4%BE%E5%86%85%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF%E5%85%A8%E6%BB%85%E5%A2%83%E7%95%8C%E9%98%B2%E5%BE%A1%E3%82%92%E9%81%8E%E4%BF%A1%E3%81%97%E3%81%9F%E7%B5%90%E6%9E%9C%E6%94%BB%E6%92%83%E8%80%85%E3%81%AB%E5%86%85%E9%83%A8%E4%BE%B5%E5%85%A5%E3%82%92%E8%A8%B1%E3%81%97%E3%81%9F5%E6%97%A5%E9%96%93%E3%81%AE%E6%82%AA%E5%A4%A2/</guid><description>&lt;h1 id="社内ネットワーク全滅境界防御を過信した結果攻撃者に内部侵入を許した5日間の悪夢">【社内ネットワーク全滅】境界防御を過信した結果、攻撃者に内部侵入を許した5日間の悪夢
&lt;/h1>&lt;h2 id="プロローグ絶対安全という思い込み">プロローグ：「絶対安全」という思い込み
&lt;/h2>&lt;p>&lt;strong>2025年7月14日（月曜日）午前9時&lt;/strong>&lt;/p>
&lt;p>「うちのネットワークは絶対安全です。最新のファイアウォールで守られているので」&lt;/p>
&lt;p>CISOの前でそう胸を張って説明していた私。まさか、その24時間後に攻撃者が社内ネットワークを完全に支配下に置いているとは夢にも思いませんでした。&lt;/p>
&lt;p>これは、境界防御への過信が招いた5日間の地獄の記録です。&lt;/p>
&lt;h2 id="第一章城郭の虚偽安全">第一章：「城郭」の虚偽安全
&lt;/h2>&lt;h3 id="私たちの完璧だった境界防御">私たちの「完璧」だった境界防御
&lt;/h3>&lt;p>当時、私たちのネットワーク構成は業界標準を満たしていると自負していました。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">Internet → [Next-Gen Firewall] → Internal Network (100% trusted zone)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ↓
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> [IDS/IPS]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> [DLP System]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> [VPN Gateway]
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;strong>セキュリティ対策（当時）：&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>最新のNext-Generation Firewall&lt;/li>
&lt;li>IDS/IPSによる侵入検知・防止&lt;/li>
&lt;li>DLPシステムでデータ漏洩防止&lt;/li>
&lt;li>VPNによる安全なリモートアクセス&lt;/li>
&lt;li>定期的なパッチ適用&lt;/li>
&lt;/ul>
&lt;p>「これだけやってれば完璧だろう」&lt;/p>
&lt;h3 id="7月15日火曜日午前10時最初の違和感">7月15日（火曜日）午前10時：最初の違和感
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">🔔 Security Alert
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">From: IDS/IPS System
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Subject: Suspicious Activity Detected
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Alert: Unusual data transfer pattern detected
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Source: employee-laptop-047 (John Smith)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Destination: external IP 203.0.113.42
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Data Volume: 2.3GB in 30 minutes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Classification: Medium Risk
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>「Johnの部署は大きなファイルを扱うし、外部パートナーとのデータ共有だろう」&lt;/p>
&lt;p>&lt;strong>この判断が、後に致命的だったと分かります。&lt;/strong>&lt;/p>
&lt;h3 id="7月15日午後2時異常事態への発展">7月15日午後2時：異常事態への発展
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">🚨 Multiple Security Alerts
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">- 15 laptops showing identical suspicious patterns
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">- Database queries increased by 340%
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">- Network traffic to unknown IPs: +450%
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">- Multiple failed login attempts: 2,347 in 1 hour
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>「これは&amp;hellip;何かおかしい」&lt;/p>
&lt;h3 id="緊急調査開始発見した恐ろしい真実">緊急調査開始：発見した恐ろしい真実
&lt;/h3>&lt;p>&lt;strong>午後4時、調査チーム結成&lt;/strong>&lt;/p>
&lt;p>ネットワークトラフィックを詳細に分析した結果、戦慄の事実が判明。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># ネットワークログ分析&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tcpdump -i eth0 -w suspicious_traffic.pcap
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 解析結果&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Wireshark Analysis Results:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">- C&lt;span class="p">&amp;amp;&lt;/span>C Server Communication: 203.0.113.42:443
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">- Data Exfiltration: 47.3GB over &lt;span class="m">6&lt;/span> hours
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">- Lateral Movement: &lt;span class="m">73&lt;/span> internal hosts compromised
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">- Persistence: &lt;span class="m">23&lt;/span> backdoors installed
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;strong>攻撃の全貌：&lt;/strong>&lt;/p>
&lt;ol>
&lt;li>&lt;strong>初期侵入&lt;/strong>: VPN経由の認証情報窃取&lt;/li>
&lt;li>&lt;strong>権限昇格&lt;/strong>: Active Directory管理者権限取得&lt;/li>
&lt;li>&lt;strong>横展開&lt;/strong>: 内部ネットワーク全体に拡散&lt;/li>
&lt;li>&lt;strong>持続化&lt;/strong>: 複数のバックドア設置&lt;/li>
&lt;li>&lt;strong>データ窃取&lt;/strong>: 顧客情報・機密文書の大量流出&lt;/li>
&lt;/ol>
&lt;p>「内部は完全に侵略されている&amp;hellip;」&lt;/p>
&lt;h2 id="第二章内部ネットワーク無法地帯の現実">第二章：内部ネットワーク「無法地帯」の現実
&lt;/h2>&lt;h3 id="午後6時被害状況の全容判明">午後6時：被害状況の全容判明
&lt;/h3>&lt;p>&lt;strong>侵害された資産：&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>ドメインコントローラー: 完全支配&lt;/li>
&lt;li>ファイルサーバー: データ暗号化攻撃&lt;/li>
&lt;li>データベースサーバー: 全顧客情報アクセス済み&lt;/li>
&lt;li>財務システム: 取引データ流出&lt;/li>
&lt;li>人事システム: 従業員個人情報流出&lt;/li>
&lt;li>開発環境: ソースコード窃取&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>影響範囲：&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">Compromised Assets Summary:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">├── Domain Controllers: 3/3 (100%)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">├── File Servers: 15/15 (100%)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">├── Database Servers: 8/8 (100%)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">├── Application Servers: 23/23 (100%)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">├── Employee Workstations: 247/250 (98.8%)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">└── Network Infrastructure: Router/Switch Config Modified
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>「これ&amp;hellip;会社全体が乗っ取られてる」&lt;/p>
&lt;h3 id="なぜ境界防御が無力だったのか">なぜ境界防御が無力だったのか
&lt;/h3>&lt;p>&lt;strong>致命的な設計欠陥：&lt;/strong>&lt;/p>
&lt;h4 id="1-内部ネットワーク--完全信頼の思い込み">1. 内部ネットワーク = 完全信頼の思い込み
&lt;/h4>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">従来の設計（城郭モデル）:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Internet (Evil) → [Firewall] → Internal Network (100% Trusted)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">現実:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Internet (Evil) → [Firewall] → Internal Network (Evil + Good混在)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;strong>問題：&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>一度内部に入られると全てが無防備&lt;/li>
&lt;li>内部通信に対するセキュリティ制御なし&lt;/li>
&lt;li>横展開（Lateral Movement）に対する防御なし&lt;/li>
&lt;/ul>
&lt;h4 id="2-単層防御の限界">2. 単層防御の限界
&lt;/h4>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 攻撃者の視点&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Step 1: VPN認証突破 ✓
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Step 2: 内部ネットワークスキャン ✓
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Step 3: 脆弱性発見・悪用 ✓
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Step 4: 権限昇格 ✓
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Step 5: データアクセス ✓
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Step 6: データ窃取 ✓
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 我々の防御&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Step 1: ファイアウォール ✗ &lt;span class="o">(&lt;/span>VPN経由で回避&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Step 2-6: 防御機構なし ✗✗✗✗✗
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="3-内部通信の野放し状態">3. 内部通信の野放し状態
&lt;/h4>&lt;p>&lt;strong>実際のネットワークトラフィック（侵害時）：&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">10.0.1.50 → 10.0.2.100:445 (SMB) ✓ 許可
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">10.0.1.50 → 10.0.3.200:1433 (SQL) ✓ 許可
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">10.0.1.50 → 10.0.4.150:3389 (RDP) ✓ 許可
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">10.0.1.50 → 10.0.5.75:22 (SSH) ✓ 許可
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>「内部の通信は全部フリーパスだった&amp;hellip;これじゃ攻撃者の天国だ」&lt;/p>
&lt;h2 id="第三章緊急対応---5日間の戦い">第三章：緊急対応 - 5日間の戦い
&lt;/h2>&lt;h3 id="day-17月15日夜パニックと初動対応">Day 1（7月15日夜）：パニックと初動対応
&lt;/h3>&lt;p>&lt;strong>午後8時、緊急対策本部設置&lt;/strong>&lt;/p>
&lt;p>&lt;strong>メンバー：&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>CISO（最高情報セキュリティ責任者）&lt;/li>
&lt;li>IT部長&lt;/li>
&lt;li>ネットワーク管理者 3名&lt;/li>
&lt;li>セキュリティアナリスト 2名&lt;/li>
&lt;li>外部セキュリティコンサルタント&lt;/li>
&lt;li>そして私（インフラ責任者）&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>初日の対応：&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 1. 緊急遮断&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 外部インターネット接続を完全遮断&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -A OUTPUT -j DROP
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -A INPUT -j DROP
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 2. 侵害端末の隔離&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 感染確認済み247台を強制シャットダウン&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">for&lt;/span> host in &lt;span class="k">$(&lt;/span>cat compromised_hosts.txt&lt;span class="k">)&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ssh admin@&lt;span class="nv">$host&lt;/span> &lt;span class="s2">&amp;#34;sudo shutdown -h now&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">done&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 3. ドメインコントローラーの緊急停止&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Active Directory全体を停止&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;strong>結果：会社機能完全停止&lt;/strong>&lt;/p>
&lt;h3 id="day-27月16日証拠保全と被害調査">Day 2（7月16日）：証拠保全と被害調査
&lt;/h3>&lt;p>&lt;strong>フォレンジック調査の開始&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># ネットワークトラフィックの完全解析&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tcpdump -i any -s &lt;span class="m">0&lt;/span> -w full_traffic_&lt;span class="k">$(&lt;/span>date +%Y%m%d&lt;span class="k">)&lt;/span>.pcap
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># イベントログの収集・分析&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">wevtutil epl Security security_events.evtx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">wevtutil epl System system_events.evtx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># メモリダンプの取得&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">dd &lt;span class="k">if&lt;/span>&lt;span class="o">=&lt;/span>/dev/mem &lt;span class="nv">of&lt;/span>&lt;span class="o">=&lt;/span>memory_dump_&lt;span class="k">$(&lt;/span>hostname&lt;span class="k">)&lt;/span>.img
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;strong>攻撃タイムラインの再構築：&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">7月14日 23:45: 初期侵入（VPN経由）
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">7月15日 00:30: ドメイン管理者権限取得
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">7月15日 01:15: Active Directory侵害
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">7月15日 02:00: ファイルサーバー暗号化開始
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">7月15日 03:30: データベース接続・データ窃取開始
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">7月15日 04:00-09:00: 横展開（247台に拡散）
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">7月15日 09:30-14:00: 大規模データ流出（47.3GB）
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>「5時間で会社全体を支配下に置かれた&amp;hellip;」&lt;/p>
&lt;h3 id="day-37月17日復旧戦略の検討">Day 3（7月17日）：復旧戦略の検討
&lt;/h3>&lt;p>&lt;strong>選択肢の検討：&lt;/strong>&lt;/p>
&lt;ol>
&lt;li>
&lt;p>&lt;strong>完全再構築&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>全システムを初期化してクリーンインストール&lt;/li>
&lt;li>期間：2-3週間&lt;/li>
&lt;li>コスト：$500,000+&lt;/li>
&lt;li>リスク：低&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>部分的な除染&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>侵害確認済みシステムのみ再構築&lt;/li>
&lt;li>期間：1週間&lt;/li>
&lt;li>コスト：$200,000&lt;/li>
&lt;li>リスク：高（残存脅威の可能性）&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>段階的復旧&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>セキュリティ強化 → 段階的システム復旧&lt;/li>
&lt;li>期間：2週間&lt;/li>
&lt;li>コスト：$350,000&lt;/li>
&lt;li>リスク：中&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;p>&lt;strong>決定：段階的復旧 + 抜本的セキュリティ改革&lt;/strong>&lt;/p>
&lt;h3 id="day-4-57月18-19日新セキュリティアーキテクチャ設計">Day 4-5（7月18-19日）：新セキュリティアーキテクチャ設計
&lt;/h3>&lt;p>この2日間で、私たちは根本的にセキュリティアプローチを見直しました。&lt;/p>
&lt;h2 id="第四章多層防御アーキテクチャへの転換">第四章：多層防御アーキテクチャへの転換
&lt;/h2>&lt;h3 id="新設計defense-in-depth">新設計：Defense in Depth
&lt;/h3>&lt;p>&lt;strong>従来（単層）vs 新設計（多層）&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">Before: Internet → [FW] → Internal Network (trusted)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">After: Internet → [WAF] → [LB] → [App FW] → [DB FW] → Database
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ↓ ↓ ↓ ↓ ↓
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Layer1 Layer2 Layer3 Layer4 Layer5
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="layer-1-dmz非武装地帯">Layer 1: DMZ（非武装地帯）
&lt;/h4>&lt;p>&lt;strong>目的&lt;/strong>: インターネットとの最初の防御線&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">DMZ_Design&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">Subnet&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">dmz-subnet (10.0.1.0/24)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">Components&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">Cloud Armor (DDoS protection)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">Load Balancer (SSL termination)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">Reverse Proxy (request filtering)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">Security_Controls&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">Rate limiting&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">100&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">req/min per IP&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">GeoIP blocking&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Known malicious countries&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">IP allowlist&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Critical admin sources only&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">WAF rules&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">OWASP Top 10 protection&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;strong>ファイアウォール実装：&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># DMZ層の厳格な制御&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gcloud compute firewall-rules create dmz-ingress-https &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --direction&lt;span class="o">=&lt;/span>INGRESS &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --priority&lt;span class="o">=&lt;/span>&lt;span class="m">1000&lt;/span> &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --source-ranges&lt;span class="o">=&lt;/span>0.0.0.0/0 &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --target-tags&lt;span class="o">=&lt;/span>dmz &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --allow&lt;span class="o">=&lt;/span>tcp:443
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 内部への通信は特定プロトコルのみ&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gcloud compute firewall-rules create dmz-to-app &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --direction&lt;span class="o">=&lt;/span>INGRESS &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --priority&lt;span class="o">=&lt;/span>&lt;span class="m">1001&lt;/span> &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --source-tags&lt;span class="o">=&lt;/span>dmz &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --target-tags&lt;span class="o">=&lt;/span>app-layer &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --allow&lt;span class="o">=&lt;/span>tcp:8080,tcp:8443
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="layer-2-application-layer">Layer 2: Application Layer
&lt;/h4>&lt;p>&lt;strong>目的&lt;/strong>: アプリケーション固有の脅威対策&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">App_Layer_Security&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">Subnet&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">app-subnet (10.0.2.0/24)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">Components&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">Application Firewall&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">API Gateway with authentication&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">Container security scanning&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">Access_Control&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">Service-to-service authentication&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">JWT token validation&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">Request rate limiting per user&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">Input validation &amp;amp; sanitization&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="layer-3-database-layer">Layer 3: Database Layer
&lt;/h4>&lt;p>&lt;strong>目的&lt;/strong>: データへの最終防御線&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># データベース層の超厳格制御&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gcloud compute firewall-rules create app-to-db &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --direction&lt;span class="o">=&lt;/span>INGRESS &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --priority&lt;span class="o">=&lt;/span>&lt;span class="m">1000&lt;/span> &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --source-tags&lt;span class="o">=&lt;/span>app-layer &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --target-tags&lt;span class="o">=&lt;/span>database &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --allow&lt;span class="o">=&lt;/span>tcp:5432
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># データベース管理は専用ジャンプホストのみ&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gcloud compute firewall-rules create admin-to-db &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --direction&lt;span class="o">=&lt;/span>INGRESS &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --priority&lt;span class="o">=&lt;/span>&lt;span class="m">1001&lt;/span> &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --source-tags&lt;span class="o">=&lt;/span>admin-bastion &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --target-tags&lt;span class="o">=&lt;/span>database &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --allow&lt;span class="o">=&lt;/span>tcp:5432
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="ゼロトラストモデルの導入">ゼロトラストモデルの導入
&lt;/h3>&lt;p>&lt;strong>基本原則：「Trust Nothing, Verify Everything」&lt;/strong>&lt;/p>
&lt;h4 id="1-identity--access-management-iam">1. Identity &amp;amp; Access Management (IAM)
&lt;/h4>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">ZeroTrust_IAM&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">Principles&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="kc">No&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">implicit trust based on location&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">Continuous authentication &amp;amp; authorization&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">Least privilege access&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">Multi-factor authentication mandatory&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">Implementation&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">Identity_Provider&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Google Cloud Identity&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">Policies&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">User identity verification every 4 hours&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">Device compliance checking&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">Location-based risk assessment&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">Behavior analytics for anomaly detection&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="2-micro-segmentation">2. Micro-Segmentation
&lt;/h4>&lt;p>&lt;strong>ネットワークの細分化：&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 部署別セグメント分離&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gcloud compute firewall-rules create deny-cross-department &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --direction&lt;span class="o">=&lt;/span>INGRESS &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --priority&lt;span class="o">=&lt;/span>&lt;span class="m">65000&lt;/span> &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --source-tags&lt;span class="o">=&lt;/span>hr-dept &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --target-tags&lt;span class="o">=&lt;/span>finance-dept &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --action&lt;span class="o">=&lt;/span>DENY &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --rules&lt;span class="o">=&lt;/span>all
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># アプリケーション層の分離&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gcloud compute firewall-rules create web-to-app-only &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --direction&lt;span class="o">=&lt;/span>INGRESS &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --priority&lt;span class="o">=&lt;/span>&lt;span class="m">1000&lt;/span> &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --source-tags&lt;span class="o">=&lt;/span>web-tier &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --target-tags&lt;span class="o">=&lt;/span>app-tier &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --allow&lt;span class="o">=&lt;/span>tcp:8080
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gcloud compute firewall-rules create app-to-db-only &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --direction&lt;span class="o">=&lt;/span>INGRESS &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --priority&lt;span class="o">=&lt;/span>&lt;span class="m">1001&lt;/span> &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --source-tags&lt;span class="o">=&lt;/span>app-tier &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --target-tags&lt;span class="o">=&lt;/span>db-tier &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --allow&lt;span class="o">=&lt;/span>tcp:5432
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="3-continuous-monitoring--analytics">3. Continuous Monitoring &amp;amp; Analytics
&lt;/h4>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># セキュリティ監視システム&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">SecurityMonitor&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="fm">__init__&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">threat_detection&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ThreatDetectionEngine&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">behavior_analytics&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">BehaviorAnalytics&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">incident_response&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">IncidentResponseSystem&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">monitor_network_traffic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;リアルタイムネットワーク監視&amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">while&lt;/span> &lt;span class="kc">True&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">traffic&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">capture_traffic&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 異常検知&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">threat_detection&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">is_suspicious&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">traffic&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">alert&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">generate_alert&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">traffic&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">incident_response&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">handle&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">alert&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 行動分析&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">user_behavior&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">behavior_analytics&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">analyze&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">traffic&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">user_behavior&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">risk_score&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="mf">0.8&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">enforce_additional_auth&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">user_behavior&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">user_id&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">enforce_additional_auth&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">user_id&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;リスクベース追加認証&amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">iam_service&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">require_mfa&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">user_id&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">iam_service&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">reduce_privileges&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">user_id&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">duration&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">3600&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="第五章復旧作業と新システム実装">第五章：復旧作業と新システム実装
&lt;/h2>&lt;h3 id="7月20日8月3日段階的復旧作業">7月20日〜8月3日：段階的復旧作業
&lt;/h3>&lt;h4 id="phase-1-セキュリティ基盤構築7月20-24日">Phase 1: セキュリティ基盤構築（7月20-24日）
&lt;/h4>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 新VPC作成（ゼロトラスト設計）&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gcloud compute networks create secure-vpc --subnet-mode&lt;span class="o">=&lt;/span>custom
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 多層セグメント作成&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gcloud compute networks subnets create dmz-subnet &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --network&lt;span class="o">=&lt;/span>secure-vpc &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --range&lt;span class="o">=&lt;/span>10.0.1.0/24 &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --region&lt;span class="o">=&lt;/span>asia-northeast1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gcloud compute networks subnets create app-subnet &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --network&lt;span class="o">=&lt;/span>secure-vpc &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --range&lt;span class="o">=&lt;/span>10.0.2.0/24 &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --region&lt;span class="o">=&lt;/span>asia-northeast1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gcloud compute networks subnets create db-subnet &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --network&lt;span class="o">=&lt;/span>secure-vpc &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --range&lt;span class="o">=&lt;/span>10.0.3.0/24 &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --region&lt;span class="o">=&lt;/span>asia-northeast1
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="phase-2-identity--access-刷新7月25-29日">Phase 2: Identity &amp;amp; Access 刷新（7月25-29日）
&lt;/h4>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 全アカウントの再発行&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">for&lt;/span> user in &lt;span class="k">$(&lt;/span>gcloud iam service-accounts list --format&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;value(email)&amp;#34;&lt;/span>&lt;span class="k">)&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> gcloud iam service-accounts delete &lt;span class="nv">$user&lt;/span> --quiet
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">done&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 新しいIAM構造&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gcloud organizations add-iam-policy-binding &lt;span class="nv">$ORG_ID&lt;/span> &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --member&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;group:security-admins@company.com&amp;#39;&lt;/span> &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --role&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;roles/securitycenter.admin&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 条件付きアクセス設定&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gcloud identity groups create security-team@company.com &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --description&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;Security team with elevated privileges&amp;#34;&lt;/span> &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --display-name&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;Security Team&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="phase-3-アプリケーション復旧7月30日8月3日">Phase 3: アプリケーション復旧（7月30日〜8月3日）
&lt;/h4>&lt;p>&lt;strong>Zero-Trust原則でのアプリケーション再展開：&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># application-deployment.yaml&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">apps/v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Deployment&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">secure-webapp&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">replicas&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">3&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">template&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">serviceAccountName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">webapp-sa&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">securityContext&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">runAsNonRoot&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">runAsUser&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">1000&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">fsGroup&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">2000&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">containers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">webapp&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">secure-webapp:v2.0&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">securityContext&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">allowPrivilegeEscalation&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">readOnlyRootFilesystem&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">capabilities&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">drop&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">ALL&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">env&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">DB_CONNECTION&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">valueFrom&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">secretKeyRef&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">db-credentials&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">key&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">connection-string&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="新セキュリティシステムの効果測定">新セキュリティシステムの効果測定
&lt;/h3>&lt;p>&lt;strong>1ヶ月後の比較：&lt;/strong>&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>指標&lt;/th>
&lt;th>旧システム&lt;/th>
&lt;th>新システム&lt;/th>
&lt;th>改善率&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>&lt;strong>平均検知時間&lt;/strong>&lt;/td>
&lt;td>6時間&lt;/td>
&lt;td>2分&lt;/td>
&lt;td>99.4%改善&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;strong>横展開阻止率&lt;/strong>&lt;/td>
&lt;td>0%&lt;/td>
&lt;td>98.5%&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;strong>誤検知率&lt;/strong>&lt;/td>
&lt;td>45%&lt;/td>
&lt;td>8%&lt;/td>
&lt;td>82%改善&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;strong>インシデント対応時間&lt;/strong>&lt;/td>
&lt;td>4時間&lt;/td>
&lt;td>15分&lt;/td>
&lt;td>93.8%改善&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;strong>データ流出検知&lt;/strong>&lt;/td>
&lt;td>事後（5日後）&lt;/td>
&lt;td>リアルタイム&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h2 id="第六章予期しなかった副次効果">第六章：予期しなかった副次効果
&lt;/h2>&lt;h3 id="ポジティブな変化">ポジティブな変化
&lt;/h3>&lt;h4 id="1-組織文化の変革">1. 組織文化の変革
&lt;/h4>&lt;p>&lt;strong>Before（セキュリティ事故前）:&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">従業員: &amp;#34;セキュリティ？IT部門の仕事でしょ&amp;#34;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">IT部門: &amp;#34;ファイアウォールがあるから大丈夫&amp;#34;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">経営陣: &amp;#34;セキュリティは必要悪、コストセンター&amp;#34;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;strong>After（現在）:&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">従業員: &amp;#34;自分もセキュリティの一部。異常を見つけたらすぐ報告&amp;#34;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">IT部門: &amp;#34;ゼロトラスト。すべてを疑い、すべてを検証&amp;#34;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">経営陣: &amp;#34;セキュリティは事業継続の生命線。投資優先項目&amp;#34;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="2-システムパフォーマンスの向上">2. システムパフォーマンスの向上
&lt;/h4>&lt;p>意外なことに、多層防御導入後、システム全体のパフォーマンスが向上しました。&lt;/p>
&lt;p>&lt;strong>理由：&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>ネットワークセグメンテーションにより不要トラフィック削減&lt;/li>
&lt;li>監視システムにより異常プロセスの早期発見・停止&lt;/li>
&lt;li>リソース使用の最適化&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">Before: 平均レスポンス時間 2.3秒
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">After: 平均レスポンス時間 1.1秒（52%改善）
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="3-開発プロセスの品質向上">3. 開発プロセスの品質向上
&lt;/h4>&lt;p>セキュリティ要件が開発初期段階から組み込まれるようになり、結果的にコード品質が大幅に向上。&lt;/p>
&lt;p>&lt;strong>セキュアコーディング標準の導入：&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Before: 脆弱な実装&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">get_user_data&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">user_id&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">query&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="sa">f&lt;/span>&lt;span class="s2">&amp;#34;SELECT * FROM users WHERE id = &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">user_id&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">database&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">execute&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">query&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># After: セキュアな実装&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">get_user_data&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">user_id&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nb">int&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">current_user&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">User&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">-&amp;gt;&lt;/span> &lt;span class="n">Optional&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">UserData&lt;/span>&lt;span class="p">]:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 認証チェック&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">current_user&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">is_authenticated&lt;/span>&lt;span class="p">():&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">raise&lt;/span> &lt;span class="n">UnauthorizedException&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;User not authenticated&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 認可チェック&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">current_user&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">can_access_user&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">user_id&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">raise&lt;/span> &lt;span class="n">ForbiddenException&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Access denied&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># SQLインジェクション対策&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">query&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;SELECT * FROM users WHERE id = &lt;/span>&lt;span class="si">%s&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">database&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">execute_safe&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">query&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">user_id&lt;/span>&lt;span class="p">,))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># データマスキング&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">mask_sensitive_data&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">current_user&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">role&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="ネガティブな影響と対処">ネガティブな影響と対処
&lt;/h3>&lt;h4 id="1-初期の運用負荷増大">1. 初期の運用負荷増大
&lt;/h4>&lt;p>&lt;strong>問題：&lt;/strong>
新システム導入直後、運用チームの負荷が一時的に300%増加。&lt;/p>
&lt;p>&lt;strong>対処：&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>自動化スクリプトの積極導入&lt;/li>
&lt;li>運用チームの増員（2名 → 5名）&lt;/li>
&lt;li>外部サポートの活用（6ヶ月間）&lt;/li>
&lt;/ul>
&lt;h4 id="2-ユーザビリティの一時的低下">2. ユーザビリティの一時的低下
&lt;/h4>&lt;p>&lt;strong>問題：&lt;/strong>
多要素認証の導入により、ユーザーからの苦情が増加。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">User Complaint Examples:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;#34;1日に何回もパスワード入力させないで&amp;#34;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;#34;スマホを持ってない時にアクセスできない&amp;#34;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;#34;以前より操作が面倒になった&amp;#34;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;strong>対処：&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>シングルサインオン（SSO）の導入&lt;/li>
&lt;li>リスクベース認証（低リスク時は認証頻度を低減）&lt;/li>
&lt;li>ユーザー教育プログラムの実施&lt;/li>
&lt;/ul>
&lt;h2 id="第七章1年後の振り返りと学び">第七章：1年後の振り返りと学び
&lt;/h2>&lt;h3 id="数値で見る改善効果">数値で見る改善効果
&lt;/h3>&lt;p>&lt;strong>セキュリティ指標（1年間）：&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>&lt;strong>セキュリティインシデント&lt;/strong>: 124件 → 3件（97.6%削減）&lt;/li>
&lt;li>&lt;strong>データ漏洩事故&lt;/strong>: 1件（重大）→ 0件&lt;/li>
&lt;li>&lt;strong>マルウェア感染&lt;/strong>: 89件 → 1件（98.9%削減）&lt;/li>
&lt;li>&lt;strong>内部不正の検知&lt;/strong>: 0件（検知不可）→ 7件検知・防止&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>ビジネス指標：&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>&lt;strong>システム可用性&lt;/strong>: 97.3% → 99.8%&lt;/li>
&lt;li>&lt;strong>顧客満足度&lt;/strong>: 7.2/10 → 8.9/10&lt;/li>
&lt;li>&lt;strong>従業員の満足度&lt;/strong>: 6.8/10 → 8.5/10&lt;/li>
&lt;/ul>
&lt;h3 id="最も重要な学び">最も重要な学び
&lt;/h3>&lt;h4 id="1-境界防御の限界">1. 境界防御の限界
&lt;/h4>&lt;p>&lt;strong>従来の考え：&lt;/strong>「外と内の境界を厳重に守れば安全」&lt;/p>
&lt;p>**現実：**攻撃者は必ず内部に侵入してくる。重要なのは侵入後の拡散防止。&lt;/p>
&lt;h4 id="2-ゼロトラストの真の価値">2. ゼロトラストの真の価値
&lt;/h4>&lt;p>&lt;strong>単なる技術論ではなく、思想の変革：&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>「信頼」を前提とした設計からの脱却&lt;/li>
&lt;li>継続的な検証・監視の重要性&lt;/li>
&lt;li>Identity中心のセキュリティモデル&lt;/li>
&lt;/ul>
&lt;h4 id="3-セキュリティは人が作る">3. セキュリティは「人」が作る
&lt;/h4>&lt;p>&lt;strong>技術だけでは不十分：&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>従業員のセキュリティ意識向上が最重要&lt;/li>
&lt;li>組織文化の変革が技術導入の前提&lt;/li>
&lt;li>継続的な教育・啓発の必要性&lt;/li>
&lt;/ul>
&lt;h3 id="他社への提言">他社への提言
&lt;/h3>&lt;p>この経験を踏まえ、同じような境界防御に依存している組織への提言：&lt;/p>
&lt;h4 id="段階的ゼロトラスト移行ロードマップ">段階的ゼロトラスト移行ロードマップ
&lt;/h4>&lt;p>&lt;strong>Phase 1: 現状分析（1ヶ月）&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># ネットワーク構成の可視化&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nmap -sn 10.0.0.0/8 &lt;span class="c1"># 内部ネットワークのスキャン&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">netstat -tuln &lt;span class="c1"># 開放ポートの確認&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ss -tulpn &lt;span class="c1"># プロセス別ポート使用状況&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;strong>Phase 2: 重要資産の特定と分離（2ヶ月）&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 重要データベースの分離&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gcloud compute networks subnets create critical-db-subnet &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --network&lt;span class="o">=&lt;/span>main-vpc &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --range&lt;span class="o">=&lt;/span>10.0.99.0/24
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 管理アクセスの制限&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gcloud compute firewall-rules create admin-access-only &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --direction&lt;span class="o">=&lt;/span>INGRESS &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --source-service-accounts&lt;span class="o">=&lt;/span>admin@company.com &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --target-tags&lt;span class="o">=&lt;/span>critical-systems &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --allow&lt;span class="o">=&lt;/span>tcp:22,tcp:3389
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;strong>Phase 3: Identity &amp;amp; Access の刷新（3ヶ月）&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>全アカウントの見直し&lt;/li>
&lt;li>多要素認証の段階導入&lt;/li>
&lt;li>特権アクセス管理（PAM）の実装&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>Phase 4: ネットワークセグメンテーション（6ヶ月）&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>部署別・機能別のセグメント分離&lt;/li>
&lt;li>内部ファイアウォールルールの実装&lt;/li>
&lt;li>監視システムの強化&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>Phase 5: 継続的な改善（継続）&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>脅威インテリジェンスの活用&lt;/li>
&lt;li>セキュリティ訓練の実施&lt;/li>
&lt;li>インシデント対応訓練&lt;/li>
&lt;/ul>
&lt;h2 id="まとめ850000と5日間の地獄で学んだこと">まとめ：$850,000と5日間の地獄で学んだこと
&lt;/h2>&lt;h3 id="事故の総コスト">事故の総コスト
&lt;/h3>&lt;p>&lt;strong>直接的コスト：&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>システム復旧費用: $350,000&lt;/li>
&lt;li>フォレンジック調査: $150,000&lt;/li>
&lt;li>法的対応: $200,000&lt;/li>
&lt;li>新セキュリティシステム: $150,000&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>間接的コスト：&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>事業停止による機会損失: $2,300,000&lt;/li>
&lt;li>顧客流出: $680,000&lt;/li>
&lt;li>信頼回復のためのマーケティング: $420,000&lt;/li>
&lt;li>人件費（緊急対応）: $180,000&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>総コスト: $4,480,000&lt;/strong>&lt;/p>
&lt;h3 id="最も価値のある教訓">最も価値のある教訓
&lt;/h3>&lt;h4 id="1-セキュリティは保険ではなく投資">1. セキュリティは「保険」ではなく「投資」
&lt;/h4>&lt;p>&lt;strong>従来の考え：&lt;/strong>
「セキュリティはコスト。事故が起きなければ無駄な投資」&lt;/p>
&lt;p>&lt;strong>新しい理解：&lt;/strong>
「セキュリティは事業継続のための必須投資。ROIは明確に測定可能」&lt;/p>
&lt;h4 id="2-完璧な防御は幻想">2. 「完璧な防御」は幻想
&lt;/h4>&lt;p>&lt;strong>境界防御の限界を受け入れる：&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>攻撃者の侵入は前提とする&lt;/li>
&lt;li>重要なのは早期検知と迅速な対応&lt;/li>
&lt;li>被害の最小化こそが現実的な目標&lt;/li>
&lt;/ul>
&lt;h4 id="3-組織全体のセキュリティ文化が最重要">3. 組織全体のセキュリティ文化が最重要
&lt;/h4>&lt;p>&lt;strong>技術 &amp;lt; プロセス &amp;lt; 人間&lt;/strong>&lt;/p>
&lt;p>最高の技術を導入しても、人間が適切に使えなければ意味がない。&lt;/p>
&lt;h3 id="未来への展望">未来への展望
&lt;/h3>&lt;h4 id="次世代セキュリティアーキテクチャ">次世代セキュリティアーキテクチャ
&lt;/h4>&lt;p>現在、私たちは次のステップとして以下に取り組んでいます：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">Next_Generation_Security&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">AI_Powered_Threat_Detection&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">Machine Learning anomaly detection&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">Behavioral analysis automation&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">Predictive threat intelligence&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">Automated_Response&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">Self-healing security systems&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">Automated incident containment&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">Dynamic policy adjustment&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">Extended_Zero_Trust&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">IoT device security integration&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">Supply chain security&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">Third-party integration security&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="最後に同じ過ちを犯さないために">最後に：同じ過ちを犯さないために
&lt;/h3>&lt;p>この記事を読んでいるあなたの組織が、私たちと同じ5日間の地獄を経験する必要はありません。&lt;/p>
&lt;p>&lt;strong>今すぐできるセキュリティチェック：&lt;/strong>&lt;/p>
&lt;ol>
&lt;li>&lt;strong>内部ネットワーク通信の監視はしていますか？&lt;/strong>&lt;/li>
&lt;li>&lt;strong>最後に行ったペネトレーションテストはいつですか？&lt;/strong>&lt;/li>
&lt;li>&lt;strong>従業員全員がセキュリティ教育を受けていますか？&lt;/strong>&lt;/li>
&lt;li>&lt;strong>インシデント対応計画は定期的に演習していますか？&lt;/strong>&lt;/li>
&lt;/ol>
&lt;p>一つでも「No」があれば、今すぐ対策を始めることをお勧めします。&lt;/p>
&lt;p>&lt;strong>境界防御だけでは不十分。多層防御とゼロトラストで、真のセキュリティを。&lt;/strong>&lt;/p>
&lt;p>これが、$4,480,000と5日間の地獄から学んだ、最も大切な教訓です。&lt;/p>
&lt;hr>
&lt;p>&lt;strong>関連記事：&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>&lt;a class="link" href="https://firebird-techtalktech.com/tags/zerotrust/" >ゼロトラスト実装の実践的ガイド&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://firebird-techtalktech.com/categories/%e3%82%bb%e3%82%ad%e3%83%a5%e3%83%aa%e3%83%86%e3%82%a3/" >インシデント対応の体系的手法&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://firebird-techtalktech.com/tags/%e3%82%bb%e3%82%ad%e3%83%a5%e3%83%aa%e3%83%86%e3%82%a3%e7%9b%a3%e6%9f%bb/" >セキュリティ監査で発見した致命的な設定ミス集&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>注意：&lt;/strong> 本記事は実際のセキュリティインシデント経験に基づいていますが、具体的な企業名や技術的詳細は一部変更・匿名化しています。&lt;/p></description></item><item><title>Cloud WorkstationsからGitHubへの安全なアクセスを実現する - Secure Web Proxyによるリポジトリレベル制御</title><link>https://firebird-techtalktech.com/post/cloud-workstations%E3%81%8B%E3%82%89github%E3%81%B8%E3%81%AE%E5%AE%89%E5%85%A8%E3%81%AA%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%82%92%E5%AE%9F%E7%8F%BE%E3%81%99%E3%82%8B-secure-web-proxy%E3%81%AB%E3%82%88%E3%82%8B%E3%83%AA%E3%83%9D%E3%82%B8%E3%83%88%E3%83%AA%E3%83%AC%E3%83%99%E3%83%AB%E5%88%B6%E5%BE%A1/</link><pubDate>Sun, 14 Sep 2025 13:25:00 +0900</pubDate><guid>https://firebird-techtalktech.com/post/cloud-workstations%E3%81%8B%E3%82%89github%E3%81%B8%E3%81%AE%E5%AE%89%E5%85%A8%E3%81%AA%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%82%92%E5%AE%9F%E7%8F%BE%E3%81%99%E3%82%8B-secure-web-proxy%E3%81%AB%E3%82%88%E3%82%8B%E3%83%AA%E3%83%9D%E3%82%B8%E3%83%88%E3%83%AA%E3%83%AC%E3%83%99%E3%83%AB%E5%88%B6%E5%BE%A1/</guid><description>&lt;h1 id="cloud-workstationsからgithubへの安全なアクセスを実現する---secure-web-proxyによるリポジトリレベル制御">Cloud WorkstationsからGitHubへの安全なアクセスを実現する - Secure Web Proxyによるリポジトリレベル制御
&lt;/h1>&lt;h2 id="はじめに">はじめに
&lt;/h2>&lt;p>開発環境のセキュリティを確保しながら、開発者の生産性を維持することは常に課題です。特にクラウドベースの開発環境では、外部リポジトリへのアクセス制御が重要になります。&lt;/p>
&lt;p>本記事では、Google Cloud WorkstationsからGitHubの特定リポジトリのみにアクセスを許可する、Secure Web Proxyを使った実装方法を解説します。&lt;/p>
&lt;h2 id="解決したい課題">解決したい課題
&lt;/h2>&lt;p>Cloud Workstationsを使用する際、以下の課題に直面しました：&lt;/p>
&lt;ol>
&lt;li>&lt;strong>セキュリティ要件&lt;/strong>: 開発環境から外部への無制限なアクセスは許可できない&lt;/li>
&lt;li>&lt;strong>開発効率&lt;/strong>: GitHubリポジトリへのアクセスは必須&lt;/li>
&lt;li>&lt;strong>きめ細かい制御&lt;/strong>: 組織全体ではなく、必要なリポジトリのみアクセス許可したい&lt;/li>
&lt;/ol>
&lt;p>従来のアプローチでは、組織全体（&lt;code>github.com/myorg/*&lt;/code>）へのアクセスを許可することが一般的でしたが、これでは従業員が個人的に作成したリポジトリへの意図しないデータ流出リスクがありました。&lt;/p>
&lt;h2 id="アーキテクチャ概要">アーキテクチャ概要
&lt;/h2>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">┌─────────────────────┐
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│ Cloud Workstation │
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│ (VPC内) │
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">└──────────┬──────────┘
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> │ Private IP
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ▼
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">┌─────────────────────┐
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│ Secure Web Proxy │
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│ - TLS Inspection │
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│ - URL Filtering │
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">└──────────┬──────────┘
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> │
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ▼
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">┌─────────────────────┐
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│ GitHub │
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│ (特定リポジトリ) │
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">└─────────────────────┘
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="実装詳細">実装詳細
&lt;/h2>&lt;h3 id="1-secure-web-proxyの基本設定">1. Secure Web Proxyの基本設定
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-hcl" data-lang="hcl">&lt;span class="line">&lt;span class="cl">&lt;span class="k">resource&lt;/span> &lt;span class="s2">&amp;#34;google_network_security_gateway_security_policy&amp;#34; &amp;#34;main&amp;#34;&lt;/span> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> project&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">var&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">project_id&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> location&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">var&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">region&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;${var.prefix}-workstation-policy&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> description&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;Security policy for Cloud Workstations&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> tls_inspection_policy&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">google_network_security_tls_inspection_policy&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">main&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">id&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>TLS inspectionを有効にすることで、HTTPS通信の中身を検査し、URLパスレベルでの制御が可能になります。&lt;/p>
&lt;h3 id="2-リポジトリ単位のアクセス制御">2. リポジトリ単位のアクセス制御
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-hcl" data-lang="hcl">&lt;span class="line">&lt;span class="cl">&lt;span class="k">resource&lt;/span> &lt;span class="s2">&amp;#34;google_network_security_gateway_security_policy_rule&amp;#34; &amp;#34;github_repo_access&amp;#34;&lt;/span> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> for_each&lt;/span> &lt;span class="o">=&lt;/span> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="k">i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">repo&lt;/span> &lt;span class="k">in&lt;/span> &lt;span class="k">var&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">allowed_github_repos&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> : 2000 + i&lt;/span> &lt;span class="o">=&lt;/span>&lt;span class="err">&amp;gt;&lt;/span> &lt;span class="k">repo&lt;/span>&lt;span class="c1"> # 動的にpriorityを割り当て
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;github-repo-${each.key}&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> description&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;Allow access to GitHub repository ${each.value}&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> priority&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">each&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">key&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> basic_profile&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;ALLOW&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> session_matcher&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;inIpRange(source.ip, &amp;#39;0.0.0.0/0&amp;#39;)&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> application_matcher&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="err">&amp;lt;&amp;lt;-&lt;/span>&lt;span class="k">_EOT_&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">url&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="k">startsWith&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="err">&amp;#39;&lt;/span>&lt;span class="k">github&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">com&lt;/span>&lt;span class="err">/&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="err">each&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="err">value&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">git&lt;/span>&lt;span class="err">/&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">_EOT_&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> tls_inspection_enabled&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kt">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> enabled&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kt">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="3-priority管理戦略">3. Priority管理戦略
&lt;/h3>&lt;p>ルールの評価順序を明確にするため、以下のpriority体系を採用：&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Priority範囲&lt;/th>
&lt;th>用途&lt;/th>
&lt;th>例&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>1000-1999&lt;/td>
&lt;td>一般的な許可URL&lt;/td>
&lt;td>パッケージリポジトリ、ドキュメント&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>2000-9999&lt;/td>
&lt;td>GitHub個別リポジトリ&lt;/td>
&lt;td>&lt;code>myorg/frontend&lt;/code>, &lt;code>myorg/backend&lt;/code>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>10000&lt;/td>
&lt;td>デフォルト拒否&lt;/td>
&lt;td>上記以外すべて拒否&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-hcl" data-lang="hcl">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 2000番台の動的割り当て
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># リポジトリが10個の場合: 2000, 2001, 2002, ..., 2009
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># リポジトリが100個の場合: 2000, 2001, ..., 2099
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="セキュリティ考慮事項">セキュリティ考慮事項
&lt;/h2>&lt;h3 id="1-session_matcherの設定">1. session_matcherの設定
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-hcl" data-lang="hcl">&lt;span class="line">&lt;span class="cl">&lt;span class="n">session_matcher&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;inIpRange(source.ip, &amp;#39;0.0.0.0/0&amp;#39;)&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>一見すると全IPを許可しているように見えますが、Secure Web ProxyはVPC内に配置されているため、実質的にVPC内のトラフィックのみが対象となります。外部からの直接アクセスは構造的に不可能です。&lt;/p>
&lt;h3 id="2-より厳密な制御が必要な場合">2. より厳密な制御が必要な場合
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-hcl" data-lang="hcl">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 特定のWorkstationサブネットのみに制限
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="n">session_matcher&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;inIpRange(source.ip, &amp;#39;10.0.1.0/24&amp;#39;)&amp;#34;&lt;/span>&lt;span class="c1">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># HTTPメソッドも制限
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="n">application_matcher&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="err">&amp;lt;&amp;lt;-&lt;/span>&lt;span class="k">_EOT_&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">url&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="k">startsWith&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="err">&amp;#39;&lt;/span>&lt;span class="k">github&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">com&lt;/span>&lt;span class="err">/&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="err">each&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="err">value&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">git&lt;/span>&lt;span class="err">/&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="err">&amp;amp;&amp;amp;&lt;/span> &lt;span class="k">request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">method&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">matches&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="err">&amp;#39;^&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">GET&lt;/span>&lt;span class="err">|&lt;/span>&lt;span class="k">POST&lt;/span>&lt;span class="err">|&lt;/span>&lt;span class="k">HEAD&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="err">$&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">_EOT_&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="3-時間帯制御オプション">3. 時間帯制御（オプション）
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-hcl" data-lang="hcl">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 営業時間内のみアクセス許可
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="n">session_matcher&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="err">&amp;lt;&amp;lt;-&lt;/span>&lt;span class="k">EOT&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">inIpRange&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">source&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">ip&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="err">&amp;#39;&lt;/span>&lt;span class="m">10&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="m">0&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="m">1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="m">0&lt;/span>&lt;span class="err">/&lt;/span>&lt;span class="m">24&lt;/span>&lt;span class="err">&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> &amp;amp;&amp;amp; request.time.getHours(&amp;#39;Asia/Tokyo&amp;#39;) &amp;gt;&lt;/span>&lt;span class="o">=&lt;/span> &lt;span class="m">9&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="err">&amp;amp;&amp;amp;&lt;/span> &lt;span class="k">request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">getHours&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="err">&amp;#39;&lt;/span>&lt;span class="k">Asia&lt;/span>&lt;span class="err">/&lt;/span>&lt;span class="k">Tokyo&lt;/span>&lt;span class="err">&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="err">&amp;lt;&lt;/span> &lt;span class="m">18&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">EOT&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="実装時の注意点">実装時の注意点
&lt;/h2>&lt;h3 id="urlマッチングの課題">URLマッチングの課題
&lt;/h3>&lt;p>現在の実装では以下の制限があります：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-hcl" data-lang="hcl">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 現在の実装
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">url&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="k">startsWith&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="err">&amp;#39;&lt;/span>&lt;span class="k">github&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">com&lt;/span>&lt;span class="err">/&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="err">each&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="err">value&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">git&lt;/span>&lt;span class="err">/&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="c1">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 問題：以下のパターンがマッチしない
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># - github.com/myorg/repo.git (末尾スラッシュなし)
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># - github.com/myorg/repo/info/refs (Git smart HTTP)
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="改善案">改善案
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-hcl" data-lang="hcl">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># より柔軟なパターンマッチング
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="n">application_matcher&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="err">&amp;lt;&amp;lt;-&lt;/span>&lt;span class="k">_EOT_&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">url&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="k">matches&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="err">&amp;#39;^&lt;/span>&lt;span class="k">github&lt;/span>&lt;span class="err">\\&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">com&lt;/span>&lt;span class="err">/&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="err">replace&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="err">each&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="err">value&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;/&amp;#34;, &amp;#34;\\/&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="err">\\&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">git&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="err">?&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="err">/&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="err">*&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="err">?$&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">_EOT_&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="動作確認">動作確認
&lt;/h2>&lt;h3 id="設定前">設定前
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ git clone https://github.com/myorg/restricted-repo.git
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Cloning into &lt;span class="s1">&amp;#39;restricted-repo&amp;#39;&lt;/span>...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">remote: Access denied
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">fatal: unable to access &lt;span class="s1">&amp;#39;https://github.com/myorg/restricted-repo.git/&amp;#39;&lt;/span>: The requested URL returned error: &lt;span class="m">403&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="設定後">設定後
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ git clone https://github.com/myorg/allowed-repo.git
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Cloning into &lt;span class="s1">&amp;#39;allowed-repo&amp;#39;&lt;/span>...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">remote: Enumerating objects: 12345, &lt;span class="k">done&lt;/span>.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">remote: Counting objects: 100% &lt;span class="o">(&lt;/span>12345/12345&lt;span class="o">)&lt;/span>, &lt;span class="k">done&lt;/span>.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 成功！&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="運用上のベストプラクティス">運用上のベストプラクティス
&lt;/h2>&lt;h3 id="1-段階的なロールアウト">1. 段階的なロールアウト
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-hcl" data-lang="hcl">&lt;span class="line">&lt;span class="cl">&lt;span class="k">variable&lt;/span> &lt;span class="s2">&amp;#34;allowed_github_repos&amp;#34;&lt;/span> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> default&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="c1">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"> # Phase 1: 必須リポジトリのみ
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="s2">&amp;#34;myorg/core-api&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="c1">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"> # Phase 2: チーム固有リポジトリ追加
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="s2">&amp;#34;myorg/frontend-app&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;myorg/mobile-app&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="c1">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"> # Phase 3: ツール・ライブラリ
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="s2">&amp;#34;myorg/shared-libraries&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="2-ログ監査">2. ログ・監査
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-hcl" data-lang="hcl">&lt;span class="line">&lt;span class="cl">&lt;span class="k">resource&lt;/span> &lt;span class="s2">&amp;#34;google_network_security_gateway_security_policy_rule&amp;#34; &amp;#34;github_repo_access&amp;#34;&lt;/span> {&lt;span class="c1">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"> # ... 他の設定 ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"> # ログ設定を追加（将来の実装）
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">log_config&lt;/span> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> enable&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kt">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> sample_rate&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="m">1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="m">0&lt;/span>&lt;span class="c1"> # 全リクエストをログ
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="3-例外処理">3. 例外処理
&lt;/h3>&lt;p>緊急時のアクセスや特殊なユースケースに対応：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-hcl" data-lang="hcl">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 緊急時用の一時的なルール（priority 1500）
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">resource&lt;/span> &lt;span class="s2">&amp;#34;google_network_security_gateway_security_policy_rule&amp;#34; &amp;#34;emergency_access&amp;#34;&lt;/span> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> count&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">var&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">enable_emergency_access&lt;/span> &lt;span class="err">?&lt;/span> &lt;span class="m">1&lt;/span> &lt;span class="err">:&lt;/span> &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> priority&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="m">1500&lt;/span>&lt;span class="c1">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"> # 特定のIPから全GitHubアクセスを許可
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="まとめ">まとめ
&lt;/h2>&lt;p>Secure Web Proxyを使用することで、Cloud WorkstationsからGitHubへのアクセスを、リポジトリレベルで細かく制御できるようになりました。&lt;/p>
&lt;h3 id="メリット">メリット
&lt;/h3>&lt;ul>
&lt;li>✅ セキュリティ: 必要最小限のアクセスのみ許可&lt;/li>
&lt;li>✅ 柔軟性: リポジトリ単位での制御が可能&lt;/li>
&lt;li>✅ 拡張性: 動的なルール生成により管理が容易&lt;/li>
&lt;li>✅ 監査性: アクセスログによる追跡が可能&lt;/li>
&lt;/ul>
&lt;h3 id="今後の改善点">今後の改善点
&lt;/h3>&lt;ul>
&lt;li>URLマッチングパターンの改善&lt;/li>
&lt;li>HTTPメソッド制限の追加&lt;/li>
&lt;li>より詳細なログ・監視の実装&lt;/li>
&lt;/ul>
&lt;p>この実装により、セキュリティと開発効率のバランスを保ちながら、クラウドネイティブな開発環境を実現できました。&lt;/p>
&lt;h2 id="参考リンク">参考リンク
&lt;/h2>&lt;ul>
&lt;li>&lt;a class="link" href="https://cloud.google.com/secure-web-proxy/docs" target="_blank" rel="noopener"
>Google Cloud Secure Web Proxy Documentation&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://git-scm.com/docs/http-protocol" target="_blank" rel="noopener"
>Git Smart HTTP Protocol&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/network_security_gateway_security_policy" target="_blank" rel="noopener"
>Terraform Google Provider - Network Security&lt;/a>&lt;/li>
&lt;/ul>
&lt;hr>
&lt;p>&lt;em>この記事は、実際のプロダクション環境での実装経験に基づいています。セキュリティ要件は組織によって異なるため、実装時は自組織のポリシーに合わせて調整してください。&lt;/em>&lt;/p></description></item><item><title>【緊急事態】Cloud Workstationsのセキュリティ事故から学んだSecure Web Proxy実装の全記録</title><link>https://firebird-techtalktech.com/post/%E7%B7%8A%E6%80%A5%E4%BA%8B%E6%85%8Bcloud-workstations%E3%81%AE%E3%82%BB%E3%82%AD%E3%83%A5%E3%83%AA%E3%83%86%E3%82%A3%E4%BA%8B%E6%95%85%E3%81%8B%E3%82%89%E5%AD%A6%E3%82%93%E3%81%A0secure-web-proxy%E5%AE%9F%E8%A3%85%E3%81%AE%E5%85%A8%E8%A8%98%E9%8C%B2/</link><pubDate>Sun, 14 Sep 2025 10:00:00 +0900</pubDate><guid>https://firebird-techtalktech.com/post/%E7%B7%8A%E6%80%A5%E4%BA%8B%E6%85%8Bcloud-workstations%E3%81%AE%E3%82%BB%E3%82%AD%E3%83%A5%E3%83%AA%E3%83%86%E3%82%A3%E4%BA%8B%E6%95%85%E3%81%8B%E3%82%89%E5%AD%A6%E3%82%93%E3%81%A0secure-web-proxy%E5%AE%9F%E8%A3%85%E3%81%AE%E5%85%A8%E8%A8%98%E9%8C%B2/</guid><description>&lt;h2 id="はじめに---まさかの事態発生">はじめに - まさかの事態発生
&lt;/h2>&lt;p>2025年8月のある金曜日、午後3時。私の携帯に緊急の電話が入りました。&lt;/p>
&lt;p>「緊急です！開発環境からプライベートリポジトリへの不正アクセスが検知されました。すぐに対応をお願いします！」&lt;/p>
&lt;p>セキュリティ部門からの一報でした。調査の結果、Cloud Workstationsを利用していた開発者が、業務で使用すべきでないプライベートなGitHubリポジトリにアクセスしていたことが判明。幸い実害はありませんでしたが、この事件をきっかけに「開発環境のアクセス制御を根本から見直す」プロジェクトが立ち上がりました。&lt;/p>
&lt;p>これは、その時の失敗と学びの記録です。&lt;/p>
&lt;h2 id="第一章楽観的な設計の落とし穴">第一章：楽観的な設計の落とし穴
&lt;/h2>&lt;h3 id="事故前の環境">事故前の環境
&lt;/h3>&lt;p>事故発生前の私たちの開発環境は、一見合理的に見えました：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># 事故前の設定（問題あり）&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">allowed_urls&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;github.com/mycompany/*&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 会社のリポジトリ全体&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;*.npmjs.org&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># npm packages&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;pypi.org&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># Python packages&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;strong>何が問題だったのか？&lt;/strong>&lt;/p>
&lt;ol>
&lt;li>&lt;strong>組織レベルの許可&lt;/strong>: &lt;code>github.com/mycompany/*&lt;/code> という設定により、社員が個人的に作成したリポジトリにもアクセス可能&lt;/li>
&lt;li>&lt;strong>監査の不備&lt;/strong>: どのリポジトリにアクセスしているかの詳細な記録がない&lt;/li>
&lt;li>&lt;strong>TLS検査なし&lt;/strong>: HTTPS通信の中身が見えず、具体的なAPIコールが追跡できない&lt;/li>
&lt;/ol>
&lt;h3 id="実際に起きた事故">実際に起きた事故
&lt;/h3>&lt;p>ある開発者が、業務時間中に個人のサイドプロジェクトのコードを会社のワークステーションにクローン。そのリポジトリには、他社のAPIキーが含まれていました。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 実際に実行されたコマンド（問題のあるもの）&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">git clone https://github.com/mycompany/developer-personal-project.git
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># ↑ このリポジトリに他社のAPIキーが含まれていた&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>結果：&lt;/p>
&lt;ul>
&lt;li>会社のネットワーク経由で外部のAPIキーが通信&lt;/li>
&lt;li>セキュリティ監視システムがアラートを発報&lt;/li>
&lt;li>コンプライアンス違反の疑いで緊急調査開始&lt;/li>
&lt;/ul>
&lt;h2 id="第二章応急処置の実装と新たな問題">第二章：応急処置の実装と新たな問題
&lt;/h2>&lt;h3 id="緊急対応とりあえずブロック">緊急対応：とりあえずブロック
&lt;/h3>&lt;p>まず、緊急対応として全てのGitHubアクセスを一時的にブロックしました。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-hcl" data-lang="hcl">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 緊急対応（全面ブロック）
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">resource&lt;/span> &lt;span class="s2">&amp;#34;google_network_security_gateway_security_policy&amp;#34; &amp;#34;emergency&amp;#34;&lt;/span> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;emergency-block-all&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> location&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">var&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">region&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> description&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;Emergency: Block all GitHub access&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">resource&lt;/span> &lt;span class="s2">&amp;#34;google_network_security_gateway_security_policy_rule&amp;#34; &amp;#34;block_github&amp;#34;&lt;/span> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;block-github&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> location&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">var&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">region&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> gateway_security_policy&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">google_network_security_gateway_security_policy&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">emergency&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">name&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> priority&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="m">100&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> session_matcher&lt;/span> &lt;span class="o">=&lt;/span>&lt;span class="n"> &amp;#34;host()&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="err">&amp;#39;&lt;/span>&lt;span class="k">github&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">com&lt;/span>&lt;span class="err">&amp;#39;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> basic_profile&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;DENY&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;strong>結果：開発が完全にストップ&lt;/strong>&lt;/p>
&lt;p>当然ですが、開発チームから猛烈な反発が。「仕事にならない」「デプロイできない」という声が次々と。&lt;/p>
&lt;h3 id="第一回目の失敗ホワイトリスト方式">第一回目の失敗：ホワイトリスト方式
&lt;/h3>&lt;p>次に試したのが、厳選されたリポジトリのみを許可するホワイトリスト方式でした。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-hcl" data-lang="hcl">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 第一回目の実装（失敗）
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">resource&lt;/span> &lt;span class="s2">&amp;#34;google_network_security_gateway_security_policy_rule&amp;#34; &amp;#34;allow_specific_repos&amp;#34;&lt;/span> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;allow-specific-repos&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> location&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">var&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">region&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> gateway_security_policy&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">google_network_security_gateway_security_policy&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">main&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">name&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> priority&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="m">100&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">session_matcher&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="err">&amp;lt;&amp;lt;-&lt;/span>&lt;span class="k">EOF&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> host()&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="err">&amp;#39;&lt;/span>&lt;span class="k">github&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">com&lt;/span>&lt;span class="err">&amp;#39;&lt;/span> &lt;span class="err">&amp;amp;&amp;amp;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="k">inUrlPath&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="err">&amp;#39;/&lt;/span>&lt;span class="k">mycompany&lt;/span>&lt;span class="err">/&lt;/span>&lt;span class="k">project&lt;/span>&lt;span class="err">-&lt;/span>&lt;span class="k">a&lt;/span>&lt;span class="err">&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="err">||&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">inUrlPath&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="err">&amp;#39;/&lt;/span>&lt;span class="k">mycompany&lt;/span>&lt;span class="err">/&lt;/span>&lt;span class="k">project&lt;/span>&lt;span class="err">-&lt;/span>&lt;span class="k">b&lt;/span>&lt;span class="err">&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="err">||&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">inUrlPath&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="err">&amp;#39;/&lt;/span>&lt;span class="k">mycompany&lt;/span>&lt;span class="err">/&lt;/span>&lt;span class="k">project&lt;/span>&lt;span class="err">-&lt;/span>&lt;span class="k">c&lt;/span>&lt;span class="err">&amp;#39;&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">EOF&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">basic_profile&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;ALLOW&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;strong>問題発生：git cloneが通らない！&lt;/strong>&lt;/p>
&lt;p>土曜日の朝8時、緊急の電話が再び。&lt;/p>
&lt;p>「git cloneができません！エラーが出ます！」&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ git clone https://github.com/mycompany/project-a.git
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">fatal: unable to access &lt;span class="s1">&amp;#39;https://github.com/mycompany/project-a.git/&amp;#39;&lt;/span>:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">The requested URL returned error: &lt;span class="m">403&lt;/span> Forbidden
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="デバッグ地獄の始まり">デバッグ地獄の始まり
&lt;/h3>&lt;p>問題の原因を特定するため、深夜までログを解析しました。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># ログ解析で判明した事実&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">curl -v https://github.com/mycompany/project-a.git/info/refs?service&lt;span class="o">=&lt;/span>git-upload-pack
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 実際のgitアクセスパターン：&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 1. https://github.com/mycompany/project-a.git/info/refs&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 2. https://github.com/mycompany/project-a/git-upload-pack&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 3. https://api.github.com/repos/mycompany/project-a&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 4. https://objects.githubusercontent.com/...&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;strong>判明した事実：gitの内部動作の複雑さ&lt;/strong>&lt;/p>
&lt;p>単純に &lt;code>/mycompany/project-a&lt;/code> を許可するだけでは不十分でした。Gitは内部的に：&lt;/p>
&lt;ol>
&lt;li>&lt;code>.git&lt;/code>サフィックスを付けてアクセス&lt;/li>
&lt;li>&lt;code>api.github.com&lt;/code> のAPIを呼び出し&lt;/li>
&lt;li>&lt;code>objects.githubusercontent.com&lt;/code> からオブジェクトをダウンロード&lt;/li>
&lt;li>リダイレクト先のURLにアクセス&lt;/li>
&lt;/ol>
&lt;h2 id="第三章tls-inspection導入での新たな壁">第三章：TLS Inspection導入での新たな壁
&lt;/h2>&lt;h3 id="tls-inspectionの実装決断">TLS Inspectionの実装決断
&lt;/h3>&lt;p>URLパスレベルでの制御を実現するため、TLS Inspectionを導入することに。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-hcl" data-lang="hcl">&lt;span class="line">&lt;span class="cl">&lt;span class="k">resource&lt;/span> &lt;span class="s2">&amp;#34;google_network_security_tls_inspection_policy&amp;#34; &amp;#34;main&amp;#34;&lt;/span> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;${var.prefix}-tls-inspection&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> location&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">var&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">region&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> ca_pool&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">google_privateca_ca_pool&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">main&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">id&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> exclude_public_ca_set&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kt">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">description&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;TLS inspection for detailed URL filtering&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;strong>新たな問題：証明書エラーの嵐&lt;/strong>&lt;/p>
&lt;p>TLS Inspectionを有効化した瞬間、開発環境は再び使用不可能に。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 大量の証明書エラー&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">curl: &lt;span class="o">(&lt;/span>60&lt;span class="o">)&lt;/span> SSL certificate problem: unable to get &lt;span class="nb">local&lt;/span> issuer certificate
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">git: fatal: unable to access &lt;span class="s1">&amp;#39;https://github.com/&amp;#39;&lt;/span>: SSL certificate verify failed
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="証明書配布の戦い">証明書配布の戦い
&lt;/h3>&lt;p>各ワークステーションに証明書を配布する必要がありました。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 各ワークステーションで実行が必要（手動配布の悪夢）&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo cp /path/to/inspection-ca.crt /usr/local/share/ca-certificates/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo update-ca-certificates
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Git用の設定&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">git config --global http.sslCAInfo /usr/local/share/ca-certificates/inspection-ca.crt
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;strong>配布作業の現実：&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>開発者50名 × 平均3台のワークステーション = 150台の設定作業&lt;/li>
&lt;li>手動配布による設定ミス多発&lt;/li>
&lt;li>開発者からの「面倒くさい」という不満の声&lt;/li>
&lt;/ul>
&lt;h2 id="第四章自動化とスクリプト化による解決">第四章：自動化とスクリプト化による解決
&lt;/h2>&lt;h3 id="自動設定スクリプトの開発">自動設定スクリプトの開発
&lt;/h3>&lt;p>証明書配布を自動化するスクリプトを作成。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/bin/bash
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>&lt;span class="c1"># setup-secure-proxy.sh&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">set&lt;/span> -euo pipefail
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 証明書ダウンロードと設定&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;Setting up secure proxy certificates...&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># GCS から証明書をダウンロード&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gsutil cp gs://company-security-certs/inspection-ca.crt /tmp/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># システムに証明書を追加&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo cp /tmp/inspection-ca.crt /usr/local/share/ca-certificates/company-inspection-ca.crt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo update-ca-certificates
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Git設定&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">git config --global http.sslCAInfo /usr/local/share/ca-certificates/company-inspection-ca.crt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Python/pip設定&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pip config &lt;span class="nb">set&lt;/span> global.cert /usr/local/share/ca-certificates/company-inspection-ca.crt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Node.js/npm設定 &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">npm config &lt;span class="nb">set&lt;/span> cafile /usr/local/share/ca-certificates/company-inspection-ca.crt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;Setup completed successfully!&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="ワークステーション起動時の自動実行">ワークステーション起動時の自動実行
&lt;/h3>&lt;p>Cloud Workstationsの起動スクリプト機能を活用。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-hcl" data-lang="hcl">&lt;span class="line">&lt;span class="cl">&lt;span class="k">resource&lt;/span> &lt;span class="s2">&amp;#34;google_workstations_workstation_config&amp;#34; &amp;#34;main&amp;#34;&lt;/span> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> workstation_config_id&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;${var.prefix}-config&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> location&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">var&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">region&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> workstation_cluster_id&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">google_workstations_workstation_cluster&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">main&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">workstation_cluster_id&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">container&lt;/span> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> image&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;us-central1-docker.pkg.dev/cloud-workstations-images/predefined/code-oss:latest&amp;#34;&lt;/span>&lt;span class="c1">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"> # 起動時に証明書設定を自動実行
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="n"> run_as_user&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="m">1000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> working_dir&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;/home/user&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">env&lt;/span> &lt;span class="o">=&lt;/span> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> &amp;#34;SETUP_SCRIPT_URL&amp;#34;&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;gs://company-scripts/setup-secure-proxy.sh&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }&lt;span class="c1">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"> # 起動時に自動実行
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">persistent_directories&lt;/span> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> mount_path&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;/home/user&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">gce_pd&lt;/span> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> size_gb&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="m">100&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="第五章最終的な解決策の実装">第五章：最終的な解決策の実装
&lt;/h2>&lt;h3 id="完成したsecure-web-proxyルール">完成したSecure Web Proxyルール
&lt;/h3>&lt;p>数週間の試行錯誤の末、完成したルールセット：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-hcl" data-lang="hcl">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 最終的な解決策
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">resource&lt;/span> &lt;span class="s2">&amp;#34;google_network_security_gateway_security_policy_rule&amp;#34; &amp;#34;allow_approved_repos&amp;#34;&lt;/span> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;allow-approved-repos&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> location&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">var&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">region&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> gateway_security_policy&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">google_network_security_gateway_security_policy&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">main&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">name&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> priority&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="m">100&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> enabled&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kt">true&lt;/span>&lt;span class="c1">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"> # 承認されたリポジトリのみ許可（正規表現使用）
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="n"> session_matcher&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="err">&amp;lt;&amp;lt;-&lt;/span>&lt;span class="k">EOF&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> host()&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="err">&amp;#39;&lt;/span>&lt;span class="k">github&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">com&lt;/span>&lt;span class="err">&amp;#39;&lt;/span> &lt;span class="err">&amp;amp;&amp;amp;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="k">inUrlPath&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="err">&amp;#39;/&lt;/span>&lt;span class="k">mycompany&lt;/span>&lt;span class="err">/&lt;/span>&lt;span class="k">project&lt;/span>&lt;span class="err">-&lt;/span>&lt;span class="k">backend&lt;/span>&lt;span class="err">&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="err">||&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">inUrlPath&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="err">&amp;#39;/&lt;/span>&lt;span class="k">mycompany&lt;/span>&lt;span class="err">/&lt;/span>&lt;span class="k">project&lt;/span>&lt;span class="err">-&lt;/span>&lt;span class="k">frontend&lt;/span>&lt;span class="err">&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="err">||&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">inUrlPath&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="err">&amp;#39;/&lt;/span>&lt;span class="k">mycompany&lt;/span>&lt;span class="err">/&lt;/span>&lt;span class="k">shared&lt;/span>&lt;span class="err">-&lt;/span>&lt;span class="k">utils&lt;/span>&lt;span class="err">&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="err">||&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">inUrlPath&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="err">&amp;#39;/&lt;/span>&lt;span class="k">mycompany&lt;/span>&lt;span class="err">/&lt;/span>&lt;span class="k">infrastructure&lt;/span>&lt;span class="err">&amp;#39;&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">EOF&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">basic_profile&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;ALLOW&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}&lt;span class="c1">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># GitHub API アクセス用
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">resource&lt;/span> &lt;span class="s2">&amp;#34;google_network_security_gateway_security_policy_rule&amp;#34; &amp;#34;allow_github_api&amp;#34;&lt;/span> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;allow-github-api&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> location&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">var&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">region&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> gateway_security_policy&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">google_network_security_gateway_security_policy&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">main&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">name&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> priority&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="m">101&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> enabled&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kt">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">session_matcher&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="err">&amp;lt;&amp;lt;-&lt;/span>&lt;span class="k">EOF&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> host()&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="err">&amp;#39;&lt;/span>&lt;span class="k">api&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">github&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">com&lt;/span>&lt;span class="err">&amp;#39;&lt;/span> &lt;span class="err">&amp;amp;&amp;amp;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="k">inUrlPath&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="err">&amp;#39;/&lt;/span>&lt;span class="k">repos&lt;/span>&lt;span class="err">/&lt;/span>&lt;span class="k">mycompany&lt;/span>&lt;span class="err">/&lt;/span>&lt;span class="k">project&lt;/span>&lt;span class="err">-&lt;/span>&lt;span class="k">backend&lt;/span>&lt;span class="err">&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="err">||&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">inUrlPath&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="err">&amp;#39;/&lt;/span>&lt;span class="k">repos&lt;/span>&lt;span class="err">/&lt;/span>&lt;span class="k">mycompany&lt;/span>&lt;span class="err">/&lt;/span>&lt;span class="k">project&lt;/span>&lt;span class="err">-&lt;/span>&lt;span class="k">frontend&lt;/span>&lt;span class="err">&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="err">||&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">inUrlPath&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="err">&amp;#39;/&lt;/span>&lt;span class="k">repos&lt;/span>&lt;span class="err">/&lt;/span>&lt;span class="k">mycompany&lt;/span>&lt;span class="err">/&lt;/span>&lt;span class="k">shared&lt;/span>&lt;span class="err">-&lt;/span>&lt;span class="k">utils&lt;/span>&lt;span class="err">&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="err">||&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">inUrlPath&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="err">&amp;#39;/&lt;/span>&lt;span class="k">repos&lt;/span>&lt;span class="err">/&lt;/span>&lt;span class="k">mycompany&lt;/span>&lt;span class="err">/&lt;/span>&lt;span class="k">infrastructure&lt;/span>&lt;span class="err">&amp;#39;&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">EOF&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">basic_profile&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;ALLOW&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}&lt;span class="c1">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Git オブジェクト配信用
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">resource&lt;/span> &lt;span class="s2">&amp;#34;google_network_security_gateway_security_policy_rule&amp;#34; &amp;#34;allow_git_objects&amp;#34;&lt;/span> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;allow-git-objects&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> location&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">var&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">region&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> gateway_security_policy&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">google_network_security_gateway_security_policy&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">main&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">name&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> priority&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="m">102&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> enabled&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kt">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">session_matcher&lt;/span> &lt;span class="o">=&lt;/span>&lt;span class="n"> &amp;#39;host()&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s2">&amp;#34;objects.githubusercontent.com&amp;#34;&lt;/span>&lt;span class="err">&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> basic_profile&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;ALLOW&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="監査とロギングの強化">監査とロギングの強化
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-hcl" data-lang="hcl">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 詳細なロギング設定
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">resource&lt;/span> &lt;span class="s2">&amp;#34;google_logging_log_sink&amp;#34; &amp;#34;proxy_logs&amp;#34;&lt;/span> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;${var.prefix}-proxy-logs&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> destination&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;bigquery.googleapis.com/projects/${var.project_id}/datasets/security_logs&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">filter&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="err">&amp;lt;&amp;lt;-&lt;/span>&lt;span class="k">EOF&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> resource.type&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;gce_network&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> AND protoPayload.serviceName&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;networksecurity.googleapis.com&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> AND protoPayload.methodName&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;google.cloud.networksecurity.v1.NetworkSecurity.EvaluatePolicy&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">EOF&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">bigquery_options&lt;/span> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n"> use_partitioned_tables&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kt">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="リポジトリ追加のプロセス自動化">リポジトリ追加のプロセス自動化
&lt;/h3>&lt;p>開発チームがストレスなく新しいリポジトリを追加できるよう、セルフサービスポータルも構築。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># repository_approval_bot.py&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">json&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">google.cloud&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">storage&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">github&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">Github&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">approve_repository_request&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;GitHub Issueからリポジトリ許可申請を処理&amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># GitHub Issueから申請情報を解析&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">issue_body&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">request&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">json&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;issue&amp;#39;&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="s1">&amp;#39;body&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">repo_name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">extract_repo_name&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">issue_body&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">business_justification&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">extract_justification&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">issue_body&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 承認ワークフロー（簡略化）&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">validate_business_case&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">business_justification&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># Terraformコードを自動更新&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">update_terraform_config&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">repo_name&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># PR作成&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">create_infrastructure_pr&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">repo_name&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># Slack通知&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">notify_security_team&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">repo_name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">business_justification&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="s1">&amp;#39;status&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s1">&amp;#39;processed&amp;#39;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="第六章運用開始後の現実">第六章：運用開始後の現実
&lt;/h2>&lt;h3 id="成功指標">成功指標
&lt;/h3>&lt;p>実装から3ヶ月後の結果：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># セキュリティ監査結果&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">- 不正アクセス事案: 0件
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">- 許可されていないリポジトリへのアクセス試行: 127件（全てブロック済）
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">- 開発者満足度: 8.2/10（初期3.1から大幅改善）
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">- リポジトリ追加申請の平均処理時間: 2.3時間（以前は2-3日）
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="想定外だった問題">想定外だった問題
&lt;/h3>&lt;p>&lt;strong>1. パフォーマンスの劣化&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># TLS Inspectionによるレイテンシ増加&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">git clone性能比較:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">- 直接アクセス: 15秒
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">- Secure Web Proxy経由: 23秒（約50%増）
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;strong>対策：&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>地域別Proxyインスタンスの配置&lt;/li>
&lt;li>キャッシュ機能の活用&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>2. 外部依存関係の問題&lt;/strong>
npmパッケージのインストールで予期しないエラーが多発。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 実際に起きた問題&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">npm install axios
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># ERROR: Unable to verify SSL certificate for registry.npmjs.org&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;strong>対策：&lt;/strong>
パッケージレジストリ用の別ルールを追加。&lt;/p>
&lt;h3 id="現在進行形の課題">現在進行形の課題
&lt;/h3>&lt;p>&lt;strong>1. 運用コスト&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>TLS Inspectionの処理によるコスト増（月額約40万円増）&lt;/li>
&lt;li>専任管理者の配置が必要&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>2. 新技術への対応&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>GitHub Codespaces使用時の制約&lt;/li>
&lt;li>Docker Hub等、新しいレジストリへの対応&lt;/li>
&lt;/ul>
&lt;h2 id="第七章得られた教訓と今後の展望">第七章：得られた教訓と今後の展望
&lt;/h2>&lt;h3 id="5つの重要な教訓">5つの重要な教訓
&lt;/h3>&lt;p>&lt;strong>1. 完璧を求めすぎない&lt;/strong>
初期は100%セキュアな環境を目指しましたが、実用性とのバランスが重要。&lt;/p>
&lt;p>&lt;strong>2. 開発者体験を軽視しない&lt;/strong>
セキュリティを理由に開発効率を著しく下げると、結果的に抜け道を作られる。&lt;/p>
&lt;p>&lt;strong>3. 段階的な導入&lt;/strong>
一度に全てを変更せず、段階的にルールを厳格化。&lt;/p>
&lt;p>&lt;strong>4. 自動化は必須&lt;/strong>
手動作業が多いと、必ず運用が破綻する。&lt;/p>
&lt;p>&lt;strong>5. 透明性の確保&lt;/strong>
なぜそのルールが必要なのか、開発者に理解してもらう。&lt;/p>
&lt;h3 id="今後の計画">今後の計画
&lt;/h3>&lt;p>&lt;strong>短期（3ヶ月以内）:&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>より細かい粒度でのアクセス制御（ブランチレベル）&lt;/li>
&lt;li>リアルタイムのアクセス監視ダッシュボード&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>中期（6ヶ月以内）:&lt;/strong>
-機械学習による異常検知&lt;/p>
&lt;ul>
&lt;li>開発者毎のリスクスコア算出&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>長期（1年以内）:&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>ゼロトラストネットワークモデルの完全実装&lt;/li>
&lt;li>他社事例の共有によるコミュニティ貢献&lt;/li>
&lt;/ul>
&lt;h2 id="まとめ失敗から学んだ本当に大切なこと">まとめ：失敗から学んだ本当に大切なこと
&lt;/h2>&lt;p>この3ヶ月間の経験で最も学んだことは、**「セキュリティと生産性は対立するものではなく、適切に設計すればお互いを高め合える」**ということです。&lt;/p>
&lt;p>最初の事故は確かに大きなインパクトでしたが、それをきっかけに組織全体でセキュリティ意識が向上し、結果的には以前より安全で効率的な開発環境を構築できました。&lt;/p>
&lt;p>重要なのは、失敗を恐れずに試行錯誤を続けること。そして、技術的な解決策だけでなく、人とプロセスの改善も同時に進めることでした。&lt;/p>
&lt;p>同じような課題に直面している方の参考になれば幸いです。何か質問があれば、お気軽にコメントをお残しください。&lt;/p>
&lt;hr>
&lt;h2 id="実装詳細資料">実装詳細資料
&lt;/h2>&lt;p>今回の実装で使用したTerraformコードやスクリプトは、&lt;a class="link" href="https://github.com/company/secure-workstation-setup" target="_blank" rel="noopener"
>こちらのGitHubリポジトリ&lt;/a>で公開しています（社内限定）。&lt;/p>
&lt;h3 id="参考文献">参考文献
&lt;/h3>&lt;ul>
&lt;li>&lt;a class="link" href="https://cloud.google.com/secure-web-proxy/docs" target="_blank" rel="noopener"
>Google Cloud Secure Web Proxy Documentation&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://cloud.google.com/workstations/docs/security-best-practices" target="_blank" rel="noopener"
>Cloud Workstations Security Best Practices&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://cloud.google.com/secure-web-proxy/docs/tls-inspection" target="_blank" rel="noopener"
>TLS Inspection Implementation Guide&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>Cloud Logging で VPC Service Controls のエラーログを確実に探す方法</title><link>https://firebird-techtalktech.com/post/cloud-logging-%E3%81%A7-vpc-service-controls-%E3%81%AE%E3%82%A8%E3%83%A9%E3%83%BC%E3%83%AD%E3%82%B0%E3%82%92%E7%A2%BA%E5%AE%9F%E3%81%AB%E6%8E%A2%E3%81%99%E6%96%B9%E6%B3%95/</link><pubDate>Sat, 13 Sep 2025 22:15:00 +0900</pubDate><guid>https://firebird-techtalktech.com/post/cloud-logging-%E3%81%A7-vpc-service-controls-%E3%81%AE%E3%82%A8%E3%83%A9%E3%83%BC%E3%83%AD%E3%82%B0%E3%82%92%E7%A2%BA%E5%AE%9F%E3%81%AB%E6%8E%A2%E3%81%99%E6%96%B9%E6%B3%95/</guid><description>&lt;p>「VPC Service Controls のエラーログ、なかなか見つからない…」&lt;/p>
&lt;p>Google Cloud を使っている多くの方が、一度はそう感じたことがあるのではないでしょうか。ただ VPC Service Controls と文字列検索しても、UI上には表示されるのに、フィルタにはヒットしないことがよくあります。&lt;/p>
&lt;p>この記事では、Cloud Logging のフィルタ機能を使って、VPC Service Controls (VPCSC) のエラーログを確実に、そして効率的に見つけ出すための方法を解説します。&lt;/p>
&lt;h2 id="なぜシンプルなフィルタでは不十分なのか">なぜシンプルなフィルタでは不十分なのか？
&lt;/h2>&lt;p>Cloud Logging の検索窓に &amp;ldquo;VPC Service Controls&amp;rdquo; と入力してもログが見つからないのは、ログの表示方法と実際のデータ構造が異なるためです。&lt;/p>
&lt;h3 id="ログの表示と実際のデータ構造の違い">ログの表示と実際のデータ構造の違い
&lt;/h3>&lt;p>Cloud Logging の UI 上で表示される「VPC Service Controls」というテキストは、ログエントリの**構造化されたデータ（JSON）**の中から抽出されたり、UI独自のラベルとして表示されていることがほとんどです。そのため、単純な文字列検索では目的のフィールドにたどり着けないのです。&lt;/p>
&lt;h3 id="vpc-sc-エラーログの特徴">VPC SC エラーログの特徴
&lt;/h3>&lt;p>VPC Service Controls のエラーログは、以下の特徴を持っています：&lt;/p>
&lt;h4 id="1-特定のログタイプに分類される">1. 特定のログタイプに分類される
&lt;/h4>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">cloudaudit.googleapis.com/policy
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>のような、ポリシー監査ログに分類されることが多いです。&lt;/p>
&lt;h4 id="2-構造化されたエラー情報">2. 構造化されたエラー情報
&lt;/h4>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;protoPayload&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;metadata&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;@type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;type.googleapis.com/google.cloud.audit.VpcServiceControlAuditMetadata&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;status&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;code&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">7&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;message&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;Request is prohibited by organization&amp;#39;s policy. vpcServiceControlsUniqueIdentifier: ...&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;details&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;violations&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;VPC_SERVICE_CONTROLS&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>このような構造の中に、エラーの理由や詳細が格納されています。&lt;/p>
&lt;h2 id="効果的なフィルタ条件3つのレシピ">効果的なフィルタ条件：3つのレシピ
&lt;/h2>&lt;p>ログの構造を理解すれば、あとは適切なフィールドを指定するだけです。以下に、VPC SC エラーを抽出するための3つの強力なフィルタ条件をご紹介します。&lt;/p>
&lt;h3 id="レシピ-1メタデータタイプでフィルタする最も正確">レシピ 1：メタデータタイプでフィルタする（最も正確）
&lt;/h3>&lt;p>VPC SC の監査ログには、固有のメタデータタイプが設定されています。これを直接指定することで、最も正確にログを絞り込めます。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">protoPayload&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">metadata&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="err">@&lt;/span>&lt;span class="n">type&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;type.googleapis.com/google.cloud.audit.VpcServiceControlAuditMetadata&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;strong>使用場面&lt;/strong>: VPC SC 関連のすべてのログを確実に抽出したい場合&lt;/p>
&lt;p>&lt;strong>メリット&lt;/strong>:&lt;/p>
&lt;ul>
&lt;li>最も正確性が高い&lt;/li>
&lt;li>偽陽性（関係ないログ）が最も少ない&lt;/li>
&lt;li>VPC SC の設定変更履歴なども含めて検索可能&lt;/li>
&lt;/ul>
&lt;h3 id="レシピ-2違反タイプでフィルタする">レシピ 2：違反タイプでフィルタする
&lt;/h3>&lt;p>VPC SC のエラーログには、violations（違反）というフィールドが含まれており、その中に違反タイプが明記されています。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">protoPayload&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">status&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">details&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">violations&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">type&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;VPC_SERVICE_CONTROLS&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;strong>使用場面&lt;/strong>: アクセス拒否など、実際の違反ログのみを見たい場合&lt;/p>
&lt;p>&lt;strong>メリット&lt;/strong>:&lt;/p>
&lt;ul>
&lt;li>エラーログに特化した検索が可能&lt;/li>
&lt;li>違反の詳細情報も同時に取得できる&lt;/li>
&lt;li>トラブルシューティングに最適&lt;/li>
&lt;/ul>
&lt;h3 id="レシピ-3ステータスメッセージでフィルタする">レシピ 3：ステータスメッセージでフィルタする
&lt;/h3>&lt;p>VPC SC によるアクセス拒否エラーのメッセージには、&lt;code>vpcServiceControlsUniqueIdentifier&lt;/code> という文字列が含まれていることが多いです。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">protoPayload&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">status&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">message&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="s2">&amp;#34;vpcServiceControlsUniqueIdentifier&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;strong>使用場面&lt;/strong>: エラーメッセージから問題を特定したい場合&lt;/p>
&lt;p>&lt;strong>メリット&lt;/strong>:&lt;/p>
&lt;ul>
&lt;li>人間が読みやすいエラーメッセージとともに検索&lt;/li>
&lt;li>ユニーク識別子でサポートケースとの照合が容易&lt;/li>
&lt;li>具体的なエラー内容が把握しやすい&lt;/li>
&lt;/ul>
&lt;h2 id="実践的な組み合わせフィルタ">実践的な組み合わせフィルタ
&lt;/h2>&lt;h3 id="基本的な組み合わせ">基本的な組み合わせ
&lt;/h3>&lt;p>上記のいずれか1つのレシピに加え、以下の条件を追加することで、より確実に目的のログにたどり着けます。&lt;/p>
&lt;h4 id="エラーログに限定">エラーログに限定
&lt;/h4>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">severity=ERROR
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>エラーログに限定することで、無駄なログを排除できます。&lt;/p>
&lt;h4 id="ログタイプを指定">ログタイプを指定
&lt;/h4>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">logName=&amp;#34;projects/YOUR_PROJECT_ID/logs/cloudaudit.googleapis.com%2Fpolicy&amp;#34;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>VPC SC のログは、ポリシー監査ログに分類されることが多いため、このログ名で検索すると効率的です。（YOUR_PROJECT_ID はご自身のプロジェクトIDに置き換えてください）&lt;/p>
&lt;h3 id="完全なフィルタ例">完全なフィルタ例
&lt;/h3>&lt;h4 id="パターン1-包括的なvpc-scログ検索">パターン1: 包括的なVPC SCログ検索
&lt;/h4>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">severity&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">ERROR&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">logName&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;projects/YOUR_PROJECT_ID/logs/cloudaudit.googleapis.com&lt;/span>&lt;span class="si">%2F&lt;/span>&lt;span class="s2">policy&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">protoPayload&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">metadata&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="err">@&lt;/span>&lt;span class="n">type&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;type.googleapis.com/google.cloud.audit.VpcServiceControlAuditMetadata&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="パターン2-アクセス拒否エラーに特化">パターン2: アクセス拒否エラーに特化
&lt;/h4>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">severity&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">ERROR&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">protoPayload&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">status&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">details&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">violations&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">type&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;VPC_SERVICE_CONTROLS&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">timestamp&lt;/span>&lt;span class="o">&amp;gt;=&lt;/span>&lt;span class="s2">&amp;#34;2025-09-13T00:00:00Z&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="パターン3-特定のサービスに関連するエラー">パターン3: 特定のサービスに関連するエラー
&lt;/h4>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">protoPayload&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">status&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">message&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="s2">&amp;#34;vpcServiceControlsUniqueIdentifier&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">protoPayload&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;storage.googleapis.com&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">severity&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">ERROR&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="ログ分析のベストプラクティス">ログ分析のベストプラクティス
&lt;/h2>&lt;h3 id="1-時間範囲の指定">1. 時間範囲の指定
&lt;/h3>&lt;p>大量のログがある環境では、時間範囲を適切に指定することが重要です：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">timestamp&amp;gt;=&amp;#34;2025-09-13T00:00:00Z&amp;#34;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">timestamp&amp;lt;=&amp;#34;2025-09-13T23:59:59Z&amp;#34;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="2-複数条件の組み合わせ">2. 複数条件の組み合わせ
&lt;/h3>&lt;p>AND条件とOR条件を適切に使い分けます：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="n">protoPayload&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">metadata&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="err">@&lt;/span>&lt;span class="n">type&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;type.googleapis.com/google.cloud.audit.VpcServiceControlAuditMetadata&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">OR&lt;/span> &lt;span class="n">protoPayload&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">status&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">details&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">violations&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">type&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;VPC_SERVICE_CONTROLS&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">AND&lt;/span> &lt;span class="n">severity&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">ERROR&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="3-結果の並び替えとエクスポート">3. 結果の並び替えとエクスポート
&lt;/h3>&lt;p>検索結果は時系列順に並び替えて分析し、必要に応じてエクスポートします：&lt;/p>
&lt;ul>
&lt;li>&lt;strong>CSV形式&lt;/strong>: スプレッドシートでの分析用&lt;/li>
&lt;li>&lt;strong>JSON形式&lt;/strong>: プログラムによる後続処理用&lt;/li>
&lt;li>&lt;strong>BigQuery&lt;/strong>: 大規模なログ分析用&lt;/li>
&lt;/ul>
&lt;h2 id="トラブルシューティング時の活用方法">トラブルシューティング時の活用方法
&lt;/h2>&lt;h3 id="1-インシデント対応での使用">1. インシデント対応での使用
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 直近1時間のVPC SCエラー&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">timestamp&lt;/span>&lt;span class="o">&amp;gt;=&lt;/span>&lt;span class="s2">&amp;#34;2025-09-13T21:00:00Z&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">severity&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">ERROR&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">protoPayload&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">status&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">details&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">violations&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">type&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;VPC_SERVICE_CONTROLS&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="2-定期的な監視">2. 定期的な監視
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 特定のリソースに対するVPC SC違反&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">protoPayload&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">resourceName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="s2">&amp;#34;projects/PROJECT_ID/buckets/BUCKET_NAME&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">protoPayload&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">metadata&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="err">@&lt;/span>&lt;span class="n">type&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;type.googleapis.com/google.cloud.audit.VpcServiceControlAuditMetadata&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="3-コンプライアンス監査">3. コンプライアンス監査
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 過去1ヶ月のすべてのVPC SC関連活動&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">timestamp&lt;/span>&lt;span class="o">&amp;gt;=&lt;/span>&lt;span class="s2">&amp;#34;2025-08-13T00:00:00Z&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">protoPayload&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">metadata&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="err">@&lt;/span>&lt;span class="n">type&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;type.googleapis.com/google.cloud.audit.VpcServiceControlAuditMetadata&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="まとめ">まとめ
&lt;/h2>&lt;p>VPC Service Controls のエラーログは、単なる文字列ではなく、ログの**構造（JSON）**を理解してフィルタをかけることが重要です。&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>フィールド&lt;/th>
&lt;th>目的&lt;/th>
&lt;th>使用場面&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>&lt;code>protoPayload.metadata.@type&lt;/code>&lt;/td>
&lt;td>最も正確なタイプでログを絞り込む&lt;/td>
&lt;td>包括的な調査&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>protoPayload.status.details.violations.type&lt;/code>&lt;/td>
&lt;td>違反の種類を特定する&lt;/td>
&lt;td>エラー分析&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>protoPayload.status.message&lt;/code>&lt;/td>
&lt;td>エラーメッセージ内の固有文字列を検索する&lt;/td>
&lt;td>トラブルシューティング&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>これらのフィルタを使えば、VPC SC のエラー調査が格段に効率化されるはずです。&lt;/p>
&lt;h3 id="次のステップ">次のステップ
&lt;/h3>&lt;ol>
&lt;li>&lt;strong>自動化&lt;/strong>: 定期的なログ監視をCloud Functionsで自動化&lt;/li>
&lt;li>&lt;strong>可視化&lt;/strong>: Cloud MonitoringでVPC SCエラーのダッシュボードを作成&lt;/li>
&lt;li>&lt;strong>アラート&lt;/strong>: 重要なVPC SC違反に対するアラートポリシーを設定&lt;/li>
&lt;/ol>
&lt;p>VPC Service Controlsは組織のセキュリティを守る重要な機能です。適切なログ分析により、セキュリティポスチャの向上と迅速な問題解決を実現できます。&lt;/p>
&lt;hr>
&lt;p>&lt;strong>関連記事&lt;/strong>:&lt;/p>
&lt;ul>
&lt;li>&lt;a class="link" href="https://firebird-techtalktech.com/tags/%e3%82%bb%e3%82%ad%e3%83%a5%e3%83%aa%e3%83%86%e3%82%a3/" >Google Cloudセキュリティベストプラクティス&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://firebird-techtalktech.com/tags/%e3%83%ad%e3%82%b0%e5%88%86%e6%9e%90/" >Cloud Loggingの効果的な活用方法&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://firebird-techtalktech.com/categories/gcp/" >GCPトラブルシューティング入門&lt;/a>&lt;/li>
&lt;/ul></description></item></channel></rss>