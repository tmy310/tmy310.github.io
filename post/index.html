<!doctype html><html lang=ja dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="技術ネタ、趣味や備忘録などを書いているブログです"><title></title><link rel=canonical href=https://firebird-techtalktech.com/post/><link rel=stylesheet href=/scss/style.min.946cca6c6259ef94ac55abfae7c7bf3291ea3ed5eea17ef77500b257217c6710.css><meta property='og:title' content="Posts"><meta property='og:description' content="技術ネタ、趣味や備忘録などを書いているブログです"><meta property='og:url' content='https://firebird-techtalktech.com/post/'><meta property='og:site_name' content='firebirdテクテクテクブログ'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta name=twitter:title content="Posts"><meta name=twitter:description content="技術ネタ、趣味や備忘録などを書いているブログです"><link rel="shortcut icon" href=/images/favicon.ico><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8ND35KCZW"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8ND35KCZW")}</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=メニューを開く・閉じる>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu_762f71fa991dd853.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>🎯</span></figure><div class=site-meta><h1 class=site-name><a href=/>firebirdテクテクテクブログ</a></h1><h2 class=site-description>技術ネタ、趣味や備忘録などを書いているブログです</h2></div></header><ol class=menu-social><li><a href=https://twitter.com/firebird19245 target=_blank title=Twitter rel=me><svg class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/categories/><span>カテゴリー</span></a></li><li><a href=/tags/><span>タグ</span></a></li><li><a href=/archives/><span>アーカイブ</span></a></li><li><a href=/search/><span>検索</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>ダークモード</span></li></ol></li></ol></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/post/></a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>読了時間: 16分</time></div></footer></div></header><section class=article-content><p>⏺ 記事1: VPC Service ControlsでのGitHub Actions対応：エラーベース権限設定のベストプラクティス</p><p>はじめに</p><p>Google Cloud の VPC Service Controls（VPC-SC）を enforced mode で運用している環境で、GitHub Actions による Terraform
実行が突然失敗するようになった経験はありませんか？</p><p>本記事では、VPC-SC 違反エラーの解決にエラーベース権限設定というアプローチを用いて、セキュリティを保ちながら効率的に権限を設定
する方法を解説します。</p><p>問題の背景</p><p>VPC Service Controls が dry-run mode から enforced mode に移行すると、今まで動いていた GitHub Actions
ワークフローが以下のようなエラーで失敗するようになります：</p><p>Error 403: Request is prohibited by organization&rsquo;s policy.
vpcServiceControlsUniqueIdentifier: xxxxx</p><p>これは、GitHub Actions の Workload Identity Federation で使用するサービスアカウントが、VPC-SC
で保護されたリソースにアクセスできなくなったためです。</p><p>エラーベース権限設定とは</p><p>従来のアプローチでは、事前に「必要そうな権限」をすべて付与することが多かったのですが、エラーベース権限設定では：</p><ol><li>最小限の権限でスタート</li><li>実際にエラーが発生したタイミングで権限を追加</li><li>エラーログから必要な権限を正確に特定</li></ol><p>このアプローチにより、真に必要な権限のみを付与することができます。</p><p>実践：エラーログの読み方</p><p>VPC-SC違反が発生すると、Cloud Logging に詳細なエラーログが記録されます：</p><p>{
&ldquo;protoPayload&rdquo;: {
&ldquo;serviceName&rdquo;: &ldquo;storage.googleapis.com&rdquo;,
&ldquo;methodName&rdquo;: &ldquo;google.storage.buckets.testIamPermissions&rdquo;,
&ldquo;authenticationInfo&rdquo;: {
&ldquo;principalEmail&rdquo;: &ldquo;<a class=link href=mailto:github-actions-plan@project.iam.gserviceaccount.com>github-actions-plan@project.iam.gserviceaccount.com</a>&rdquo;
}
}
}</p><p>このログから以下の情報を読み取れます：</p><ul><li>対象サービス: storage.googleapis.com</li><li>必要なメソッド: google.storage.buckets.testIamPermissions</li><li>エラーの主体: GitHub Actions のサービスアカウント</li></ul><p>VPC-SC Ingress Policy の設定</p><p>エラーログをもとに、ingress policy を設定します：</p><p>resource &ldquo;google_access_context_manager_service_perimeter_ingress_policy&rdquo; &ldquo;github_actions&rdquo; {
perimeter = var.service_perimeter_name</p><pre><code>ingress_from {
  identities = [
    &quot;serviceAccount:github-actions-plan@project.iam.gserviceaccount.com&quot;,
    &quot;serviceAccount:github-actions-apply@project.iam.gserviceaccount.com&quot;
  ]
  sources {
    access_level = &quot;*&quot;  # GitHub Actions の IP は動的
  }
}

ingress_to {
  resources = [&quot;projects/123456789&quot;]
  operations {
    service_name = &quot;storage.googleapis.com&quot;
    method_selectors {
      method = &quot;google.storage.buckets.testIamPermissions&quot;
    }
  }
}
</code></pre><p>}</p><p>段階的な権限追加の実例</p><p>Terraform での一般的な権限追加パターン：</p><ol><li>初期設定（Terraform state 管理）</li></ol><p>operations {
service_name = &ldquo;storage.googleapis.com&rdquo;
method_selectors {
method = &ldquo;google.storage.objects.list&rdquo;
method = &ldquo;google.storage.objects.get&rdquo;
method = &ldquo;google.storage.buckets.get&rdquo;
}
}</p><ol start=2><li>エラー発生後の追加</li></ol><p>operations {
service_name = &ldquo;storage.googleapis.com&rdquo;
method_selectors {
method = &ldquo;google.storage.objects.create&rdquo; # state更新用
method = &ldquo;google.storage.buckets.testIamPermissions&rdquo; # 権限確認用
}
}</p><ol start=3><li>BigQuery リソース管理</li></ol><p>operations {
service_name = &ldquo;bigquery.googleapis.com&rdquo;
method_selectors {
permission = &ldquo;bigquery.datasets.get&rdquo;
permission = &ldquo;bigquery.datasets.create&rdquo;
permission = &ldquo;bigquery.tables.create&rdquo;
}
}</p><p>ベストプラクティス</p><ol><li>ログ監視の自動化</li></ol><h1 id=vpc-sc違反を監視するクエリ例>VPC-SC違反を監視するクエリ例</h1><p>gcloud logging read '
protoPayload.metadata."@type"=&ldquo;type.googleapis.com/google.cloud.audit.VpcServiceControlAuditMetadata&rdquo;
AND protoPayload.authenticationInfo.principalEmail:&ldquo;github-actions&rdquo;
&rsquo; &ndash;format=&ldquo;json&rdquo;</p><ol start=2><li>権限の文書化</li></ol><p>エラーベースで追加した権限は、なぜその権限が必要なのかをコメントで記録：</p><p>operations {
service_name = &ldquo;bigquery.googleapis.com&rdquo;
method_selectors {
# Terraform での dataset 存在確認に必要
permission = &ldquo;bigquery.datasets.get&rdquo;
# BigQuery audit log sink の作成に必要
permission = &ldquo;bigquery.datasets.create&rdquo;
}
}</p><ol start=3><li>定期的な権限見直し</li></ol><p>使用されていない権限を定期的にチェック：</p><h1 id=過去30日の-api-使用状況を確認>過去30日の API 使用状況を確認</h1><p>gcloud logging read '
protoPayload.serviceName=&ldquo;bigquery.googleapis.com&rdquo;
AND protoPayload.authenticationInfo.principalEmail:&ldquo;github-actions&rdquo;
AND timestamp>=&ldquo;2024-01-01&rdquo;
&rsquo; &ndash;format=&ldquo;table(protoPayload.methodName)&rdquo;</p><p>まとめ</p><p>エラーベース権限設定は、VPC Service Controls 環境での権限管理において：</p><ul><li>セキュリティ向上: 最小権限の原則を実践</li><li>運用効率化: 不要な権限調査時間を削減</li><li>透明性確保: 権限付与の根拠が明確</li></ul><p>GitHub Actions と VPC-SC の組み合わせでお困りの際は、ぜひこのアプローチを試してみてください。</p><hr><p>記事2: Google CloudサービスのVPC Service Controls対応状況：メソッド指定の罠と対策</p><p>はじめに</p><p>VPC Service Controls（VPC-SC）で ingress/egress policy
を設定する際、サービスによってメソッド指定の対応状況が大きく異なることをご存知でしょうか？</p><p>本記事では、実際に遭遇したエラーから学んだ、Google Cloud
サービス別のメソッド指定対応状況と、それぞれの対策方法を詳しく解説します。</p><p>VPC-SC でのメソッド指定の基本</p><p>VPC-SC の ingress/egress policy では、以下の2つの方法でアクセス権限を指定できます：</p><ol><li>Permissions 指定</li></ol><p>operations {
service_name = &ldquo;bigquery.googleapis.com&rdquo;
method_selectors {
permission = &ldquo;bigquery.datasets.get&rdquo;
permission = &ldquo;bigquery.tables.create&rdquo;
}
}</p><ol start=2><li>Methods 指定</li></ol><p>operations {
service_name = &ldquo;storage.googleapis.com&rdquo;
method_selectors {
method = &ldquo;google.storage.objects.get&rdquo;
method = &ldquo;google.storage.buckets.list&rdquo;
}
}</p><p>サービス別対応状況一覧</p><p>実際に検証した結果、サービスごとに対応状況が大きく異なることが判明しました：</p><div class=table-wrapper><table><thead><tr><th>サービス</th><th>個別メソッド指定</th><th>対応形式</th><th>備考</th></tr></thead><tbody><tr><td>storage.googleapis.com</td><td>✅</td><td>フルパス</td><td>google.storage.objects.get</td></tr><tr><td>bigquery.googleapis.com</td><td>✅</td><td>permissions/methods併用</td><td>用途により使い分け</td></tr><tr><td>logging.googleapis.com</td><td>✅</td><td>短縮形式</td><td>ConfigServiceV2.GetSink</td></tr><tr><td>monitoring.googleapis.com</td><td>❌</td><td>* のみ</td><td>個別指定不可</td></tr><tr><td>secretmanager.googleapis.com</td><td>❌</td><td>* のみ</td><td>個別指定不可</td></tr><tr><td>datacatalog.googleapis.com</td><td>❌</td><td>* のみ</td><td>個別指定不可</td></tr></tbody></table></div><p>実際のエラーパターンと対策</p><p>パターン1: フルパス指定が必要なケース</p><p>エラー例（Storage）:
Error 400: METHOD &lsquo;objects.get&rsquo; is not supported in storage.googleapis.com</p><p>対策:</p><h1 id=-短縮形式>❌ 短縮形式</h1><p>method = &ldquo;objects.get&rdquo;</p><h1 id=-フルパス指定>✅ フルパス指定</h1><p>method = &ldquo;google.storage.objects.get&rdquo;</p><p>パターン2: 短縮形式でないとエラーになるケース</p><p>エラー例（Logging）:
Error 400: METHOD &lsquo;google.logging.v2.ConfigServiceV2.GetSink&rsquo; is not supported in logging.googleapis.com</p><p>対策:</p><h1 id=-フルパス>❌ フルパス</h1><p>method = &ldquo;google.logging.v2.ConfigServiceV2.GetSink&rdquo;</p><h1 id=-短縮形式-1>✅ 短縮形式</h1><p>method = &ldquo;ConfigServiceV2.GetSink&rdquo;</p><p>パターン3: 個別指定が一切サポートされないケース</p><p>エラー例（Monitoring）:
Error 400: METHOD &lsquo;NotificationChannelService.GetNotificationChannel&rsquo; is not supported in monitoring.googleapis.com</p><p>対策:</p><h1 id=-個別メソッド指定>❌ 個別メソッド指定</h1><p>method = &ldquo;NotificationChannelService.GetNotificationChannel&rdquo;</p><h1 id=-ワイルドカード使用>✅ ワイルドカード使用</h1><p>method = &ldquo;*&rdquo;</p><p>BigQuery の特殊ケース</p><p>BigQuery は permissions と methods の使い分けが重要です：</p><p>Permissions を使用するケース</p><p>operations {
service_name = &ldquo;bigquery.googleapis.com&rdquo;
method_selectors {
# データセット・テーブル操作
permission = &ldquo;bigquery.datasets.get&rdquo;
permission = &ldquo;bigquery.tables.create&rdquo;
}
}</p><p>Methods を使用するケース</p><p>operations {
service_name = &ldquo;bigquery.googleapis.com&rdquo;
method_selectors {
# 特定の API 呼び出し
method = &ldquo;DatasetService.InsertDataset&rdquo;
method = &ldquo;TableDataService.InsertAll&rdquo;
}
}</p><p>IAM 操作の罠</p><p>BigQuery での IAM 操作は特に注意が必要です：</p><h1 id=-bigquery-サービス内でのiam指定エラーになる>❌ BigQuery サービス内でのIAM指定（エラーになる）</h1><p>operations {
service_name = &ldquo;bigquery.googleapis.com&rdquo;
method_selectors {
permission = &ldquo;bigquery.datasets.getIamPolicy&rdquo; # サポート外
method = &ldquo;google.iam.v1.IAMPolicy.GetIamPolicy&rdquo; # サポート外
}
}</p><h1 id=-実際にはbigqueryの標準権限で処理される>✅ 実際にはBigQueryの標準権限で処理される</h1><p>operations {
service_name = &ldquo;bigquery.googleapis.com&rdquo;
method_selectors {
permission = &ldquo;bigquery.datasets.get&rdquo;
permission = &ldquo;bigquery.datasets.update&rdquo;
}
}</p><p>効率的な調査方法</p><ol><li>エラーメッセージからの推測</li></ol><p>エラーメッセージのパターンで対応状況を推測：</p><h1 id=パターン1-フルパス不足>パターン1: フルパス不足</h1><p>&ldquo;METHOD &lsquo;objects.get&rsquo; is not supported&rdquo;
→ google.storage.objects.get を試す</p><h1 id=パターン2-フルパス過多>パターン2: フルパス過多</h1><p>&ldquo;METHOD &lsquo;google.logging.v2.ConfigServiceV2.GetSink&rsquo; is not supported&rdquo;
→ ConfigServiceV2.GetSink を試す</p><h1 id=パターン3-個別指定不可>パターン3: 個別指定不可</h1><p>&ldquo;METHOD &lsquo;NotificationChannelService.GetNotificationChannel&rsquo; is not supported&rdquo;
→ &ldquo;*&rdquo; を使用</p><ol start=2><li>段階的テスト戦略</li></ol><h1 id=step-1-具体的メソッドを試す>Step 1: 具体的メソッドを試す</h1><p>method = &ldquo;SpecificMethod.Action&rdquo;</p><h1 id=step-2-短縮形式を試す>Step 2: 短縮形式を試す</h1><p>method = &ldquo;Action&rdquo;</p><h1 id=step-3-ワイルドカードにフォールバック>Step 3: ワイルドカードにフォールバック</h1><p>method = &ldquo;*&rdquo;</p><ol start=3><li>ドキュメント確認</li></ol><p>Google Cloud のドキュメントで対応状況を確認：</p><ul><li><a class=link href=https://cloud.google.com/vpc-service-controls/docs/supported-services target=_blank rel=noopener>https://cloud.google.com/vpc-service-controls/docs/supported-services</a></li><li>各サービスの API リファレンス</li></ul><p>まとめとベストプラクティス</p><p>対応状況の把握</p><ol><li>Storage/BigQuery: 詳細な制御が可能</li><li>Logging: 短縮形式で制御可能</li><li>Monitoring/SecretManager: ワイルドカードのみ</li></ol><p>設定時の推奨手順</p><ol><li>具体的なメソッド指定から開始</li><li>エラーに応じて形式を調整</li><li>最終手段として * を使用</li><li>設定理由をコメントで文書化</li></ol><p>コメント記載例</p><p>operations {
service_name = &ldquo;monitoring.googleapis.com&rdquo;
method_selectors {
method = &ldquo;*&rdquo; # 個別のメソッドは未サポート
}
}</p><p>VPC Service Controls の複雑な仕様に惑わされず、段階的なアプローチで効率的に設定を進めていきましょう。</p><hr><p>記事3: Terraformプロバイダーから読み解く必要なGoogle Cloud権限設計</p><p>はじめに</p><p>Terraform で Google Cloud リソースを管理する際、「どの権限が本当に必要なのか？」という疑問を持ったことはありませんか？</p><p>特に VPC Service Controls 環境では、過不足ない権限設定が重要になります。本記事では、Terraform のリソース定義から必要な Google
Cloud 権限を逆算し、効率的な権限設計を行う方法を解説します。</p><p>基本的な考え方</p><ol><li>Terraformリソース ≠ 必要権限</li></ol><p>多くの場合、Terraform の1つのリソースを管理するために複数の Google Cloud 権限が必要になります：</p><p>resource &ldquo;google_bigquery_dataset&rdquo; &ldquo;example&rdquo; {
dataset_id = &ldquo;example_dataset&rdquo;
location = &ldquo;US&rdquo;
}</p><p>このシンプルなリソースでも、実際には以下の権限が必要：</p><ul><li>bigquery.datasets.get (状態確認)</li><li>bigquery.datasets.create (作成)</li><li>bigquery.datasets.update (更新)</li></ul><ol start=2><li>CRUD操作の分析</li></ol><p>Terraform の操作フローから必要権限を導き出せます：</p><div class=table-wrapper><table><thead><tr><th>Terraform操作</th><th>必要なGoogle Cloud権限</th></tr></thead><tbody><tr><td>terraform plan</td><td>Read権限 (*.get, *.list)</td></tr><tr><td>terraform apply (作成)</td><td>Create権限 (*.create)</td></tr><tr><td>terraform apply (更新)</td><td>Update権限 (*.update, *.patch)</td></tr><tr><td>terraform destroy</td><td>Delete権限 (*.delete)</td></tr></tbody></table></div><p>実践例1: BigQuery Dataset管理</p><p>Terraformリソース定義</p><p>resource &ldquo;google_bigquery_dataset&rdquo; &ldquo;analytics&rdquo; {
dataset_id = &ldquo;analytics&rdquo;
friendly_name = &ldquo;Analytics Dataset&rdquo;
description = &ldquo;Dataset for analytics data&rdquo;
location = &ldquo;US&rdquo;</p><pre><code># データセットアクセス制御
access {
  role          = &quot;OWNER&quot;
  special_group = &quot;projectOwners&quot;
}

access {
  role         = &quot;READER&quot;
  user_by_email = &quot;analyst@example.com&quot;
}
</code></pre><p>}</p><p>必要権限の分析</p><p>基本的なデータセット操作:</p><h1 id=vpc-sc-policy設定例>VPC-SC Policy設定例</h1><p>operations {
service_name = &ldquo;bigquery.googleapis.com&rdquo;
method_selectors {
permission = &ldquo;bigquery.datasets.get&rdquo; # plan時の状態確認
permission = &ldquo;bigquery.datasets.create&rdquo; # 初回作成
permission = &ldquo;bigquery.datasets.update&rdquo; # 設定変更
}
}</p><p>アクセス制御の罠:</p><p>多くの人が見落とすのが、access ブロックによる IAM 操作です：</p><h1 id=-不十分な権限設定>❌ 不十分な権限設定</h1><p>permission = &ldquo;bigquery.datasets.get&rdquo;
permission = &ldquo;bigquery.datasets.create&rdquo;</p><h1 id=-iam操作も含めた完全な設定>✅ IAM操作も含めた完全な設定</h1><p>permission = &ldquo;bigquery.datasets.get&rdquo;
permission = &ldquo;bigquery.datasets.create&rdquo;
permission = &ldquo;bigquery.datasets.update&rdquo;</p><h1 id=access-ブロックの変更には-update-権限が必要>access ブロックの変更には update 権限が必要</h1><p>実践例2: BigQuery Dataset Access管理</p><p>より複雑なケース</p><p>resource &ldquo;google_bigquery_dataset_access&rdquo; &ldquo;analyst_access&rdquo; {
dataset_id = google_bigquery_dataset.analytics.dataset_id
role = &ldquo;READER&rdquo;
user_by_email = &ldquo;<a class=link href=mailto:analyst@example.com>analyst@example.com</a>&rdquo;
}</p><p>resource &ldquo;google_bigquery_dataset_access&rdquo; &ldquo;service_account_access&rdquo; {
dataset_id = google_bigquery_dataset.analytics.dataset_id
role = &ldquo;WRITER&rdquo;
user_by_email = &ldquo;<a class=link href=mailto:service-account@project.iam.gserviceaccount.com>service-account@project.iam.gserviceaccount.com</a>&rdquo;
}</p><p>権限設計</p><p>operations {
service_name = &ldquo;bigquery.googleapis.com&rdquo;
method_selectors {
# データセット基本操作
permission = &ldquo;bigquery.datasets.get&rdquo;
permission = &ldquo;bigquery.datasets.update&rdquo; # access変更に必要</p><pre><code>  # IAM操作（dataset_access リソース用）
  # 注意: BigQueryのIAM操作は特殊で、標準的なIAM権限ではなく
  # BigQuery固有の権限で制御される
}
</code></pre><p>}</p><p>実践例3: テーブル作成を含むケース</p><p>Terraformリソース</p><p>resource &ldquo;google_bigquery_table&rdquo; &ldquo;user_events&rdquo; {
dataset_id = google_bigquery_dataset.analytics.dataset_id
table_id = &ldquo;user_events&rdquo;</p><pre><code>time_partitioning {
  type  = &quot;DAY&quot;
  field = &quot;event_timestamp&quot;
}

schema = jsonencode([
  {
    name = &quot;user_id&quot;
    type = &quot;STRING&quot;
    mode = &quot;REQUIRED&quot;
  },
  {
    name = &quot;event_timestamp&quot;
    type = &quot;TIMESTAMP&quot;
    mode = &quot;REQUIRED&quot;
  }
])
</code></pre><p>}</p><p>拡張された権限設計</p><p>operations {
service_name = &ldquo;bigquery.googleapis.com&rdquo;
method_selectors {
# データセット操作（依存関係で必要）
permission = &ldquo;bigquery.datasets.get&rdquo;</p><pre><code>  # テーブル操作
  permission = &quot;bigquery.tables.get&quot;      # plan時の確認
  permission = &quot;bigquery.tables.create&quot;   # 作成
  permission = &quot;bigquery.tables.update&quot;   # スキーマ変更等
  permission = &quot;bigquery.tables.list&quot;     # 依存関係確認
}
</code></pre><p>}</p><p>実践例4: ロギング設定を含む複合ケース</p><p>Terraformリソース</p><p>resource &ldquo;google_logging_project_sink&rdquo; &ldquo;bigquery_sink&rdquo; {
name = &ldquo;bigquery-audit-sink&rdquo;
destination =
&ldquo;bigquery.googleapis.com/projects/${var.project}/datasets/${google_bigquery_dataset.audit_logs.dataset_id}&rdquo;
filter = &ldquo;resource.type=bigquery_resource&rdquo;
unique_writer_identity = true
}</p><p>resource &ldquo;google_bigquery_dataset&rdquo; &ldquo;audit_logs&rdquo; {
dataset_id = &ldquo;audit_logs&rdquo;
location = &ldquo;US&rdquo;</p><pre><code># Sink からの書き込み用アクセス
access {
  role          = &quot;WRITER&quot;
  user_by_email = google_logging_project_sink.bigquery_sink.writer_identity
}
</code></pre><p>}</p><p>マルチサービス権限設計</p><h1 id=bigquery権限>BigQuery権限</h1><p>operations {
service_name = &ldquo;bigquery.googleapis.com&rdquo;
method_selectors {
permission = &ldquo;bigquery.datasets.get&rdquo;
permission = &ldquo;bigquery.datasets.create&rdquo;
permission = &ldquo;bigquery.datasets.update&rdquo;
}
}</p><h1 id=logging権限>Logging権限</h1><p>operations {
service_name = &ldquo;logging.googleapis.com&rdquo;
method_selectors {
method = &ldquo;ConfigServiceV2.GetSink&rdquo; # sink状態確認
method = &ldquo;ConfigServiceV2.CreateSink&rdquo; # sink作成
method = &ldquo;ConfigServiceV2.UpdateSink&rdquo; # sink更新
}
}</p><p>権限設計のベストプラクティス</p><ol><li>段階的な権限付与戦略</li></ol><h1 id=phase-1-基本的な読み取り権限>Phase 1: 基本的な読み取り権限</h1><p>permission = &ldquo;bigquery.datasets.get&rdquo;
permission = &ldquo;bigquery.tables.get&rdquo;</p><h1 id=phase-2-作成権限初回apply時に追加>Phase 2: 作成権限（初回apply時に追加）</h1><p>permission = &ldquo;bigquery.datasets.create&rdquo;
permission = &ldquo;bigquery.tables.create&rdquo;</p><h1 id=phase-3-更新権限設定変更時に追加>Phase 3: 更新権限（設定変更時に追加）</h1><p>permission = &ldquo;bigquery.datasets.update&rdquo;
permission = &ldquo;bigquery.tables.update&rdquo;</p><ol start=2><li>依存関係の理解</li></ol><h1 id=テーブル作成にはデータセット読み取り権限も必要>テーブル作成にはデータセット読み取り権限も必要</h1><p>resource &ldquo;google_bigquery_table&rdquo; &ldquo;example&rdquo; {
dataset_id = google_bigquery_dataset.example.dataset_id # この参照により必要
table_id = &ldquo;example_table&rdquo;
}</p><h1 id=必要権限>必要権限:</h1><h1 id=--bigquerydatasetsget-依存関係確認>- bigquery.datasets.get (依存関係確認)</h1><h1 id=--bigquerytablescreate-テーブル作成>- bigquery.tables.create (テーブル作成)</h1><ol start=3><li>環境別の権限調整</li></ol><p>locals {
# 開発環境：より多くの権限
dev_permissions = [
&ldquo;bigquery.datasets.get&rdquo;,
&ldquo;bigquery.datasets.create&rdquo;,
&ldquo;bigquery.datasets.update&rdquo;,
&ldquo;bigquery.datasets.delete&rdquo;, # 開発では削除も許可
&ldquo;bigquery.tables.get&rdquo;,
&ldquo;bigquery.tables.create&rdquo;,
&ldquo;bigquery.tables.update&rdquo;,
&ldquo;bigquery.tables.delete&rdquo;
]</p><pre><code># 本番環境：最小権限
prod_permissions = [
  &quot;bigquery.datasets.get&quot;,
  &quot;bigquery.datasets.update&quot;,  # 設定変更のみ
  &quot;bigquery.tables.get&quot;,
  &quot;bigquery.tables.update&quot;     # スキーマ変更のみ
]
</code></pre><p>}</p><p>検証とモニタリング</p><ol><li>権限使用状況の確認</li></ol><h1 id=実際に使用された権限の確認>実際に使用された権限の確認</h1><p>gcloud logging read '
protoPayload.serviceName=&ldquo;bigquery.googleapis.com&rdquo;
AND protoPayload.authenticationInfo.principalEmail:&ldquo;terraform-service-account&rdquo;
AND timestamp>=TIMESTAMP_FROM_RFC3339(&ldquo;2024-01-01T00:00:00Z&rdquo;)
&rsquo; &ndash;format=&ldquo;table(protoPayload.methodName, protoPayload.authorizationInfo.permission)&rdquo;</p><ol start=2><li>不要権限の特定</li></ol><h1 id=付与されているが使用されていない権限を特定>付与されているが使用されていない権限を特定</h1><p>gcloud projects get-iam-policy PROJECT_ID<br>&ndash;flatten=&ldquo;bindings[].members&rdquo;<br>&ndash;filter=&ldquo;bindings.members:terraform-service-account&rdquo;<br>&ndash;format=&ldquo;table(bindings.role)&rdquo;</p><p>まとめ</p><p>Terraform リソースから Google Cloud 権限を設計する際のポイント：</p><ol><li>リソース定義の詳細分析: 単純なリソースでも複数の権限が必要</li><li>依存関係の考慮: 参照されるリソースの読み取り権限も必要</li><li>段階的な権限付与: plan → apply → update の流れに沿って権限を追加</li><li>環境別の調整: 開発と本番で異なる権限レベルを設定</li><li>継続的な見直し: 実際の使用状況に基づく権限の最適化</li></ol><p>適切な権限設計により、セキュリティを保ちながら効率的な Terraform 運用が実現できます。</p></section><footer class=article-footer></footer></article><footer class=site-footer><section class=copyright>&copy;
2025 トミー</section><section class=powerby>技術ネタ、趣味や備忘録などを書いているブログです<br><a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> で構築されています。<br>テーマ <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> は <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> によって設計されています。</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>