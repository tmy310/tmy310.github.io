<!doctype html><html lang=ja dir=ltr><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>firebirdテクテクテクブログ</title><meta name=keywords content><meta name=description content="⏺ 記事1: VPC Service ControlsでのGitHub Actions対応：エラーベース権限設定のベストプラクティス
はじめに
Google Cloud の VPC Service Controls（VPC-SC）を enforced mode で運用している環境で、GitHub Actions による Terraform
実行が突然失敗するようになった経験はありませんか？"><meta name=author content="トミー"><link rel=canonical href=https://firebird-techtalktech.com/post/blog/><link crossorigin=anonymous href=/assets/css/stylesheet.5727f7d5610d533548075f82f3e10fa4f6bfcbdf02c6d91f86b6a85a74bbf757.css integrity="sha256-Vyf31WENUzVIB1+C8+EPpPa/y98CxtkfhraoWnS791c=" rel="preload stylesheet" as=style><link rel=icon href=https://firebird-techtalktech.com/images/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://firebird-techtalktech.com/images/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://firebird-techtalktech.com/images/favicon-32x32.png><link rel=apple-touch-icon href=https://firebird-techtalktech.com/images/apple-touch-icon.png><link rel=mask-icon href=https://firebird-techtalktech.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=ja href=https://firebird-techtalktech.com/post/blog/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8ND35KCZW"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8ND35KCZW")</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-J8ND35KCZW"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-J8ND35KCZW")</script><meta property="og:url" content="https://firebird-techtalktech.com/post/blog/"><meta property="og:site_name" content="firebirdテクテクテクブログ"><meta property="og:title" content="firebirdテクテクテクブログ"><meta property="og:description" content="⏺ 記事1: VPC Service ControlsでのGitHub Actions対応：エラーベース権限設定のベストプラクティス
はじめに
Google Cloud の VPC Service Controls（VPC-SC）を enforced mode で運用している環境で、GitHub Actions による Terraform 実行が突然失敗するようになった経験はありませんか？"><meta property="og:locale" content="ja"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta name=twitter:card content="summary"><meta name=twitter:title content><meta name=twitter:description content="⏺ 記事1: VPC Service ControlsでのGitHub Actions対応：エラーベース権限設定のベストプラクティス
はじめに
Google Cloud の VPC Service Controls（VPC-SC）を enforced mode で運用している環境で、GitHub Actions による Terraform
実行が突然失敗するようになった経験はありませんか？"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://firebird-techtalktech.com/post/"},{"@type":"ListItem","position":2,"name":"","item":"https://firebird-techtalktech.com/post/blog/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"","name":"","description":"⏺ 記事1: VPC Service ControlsでのGitHub Actions対応：エラーベース権限設定のベストプラクティス\nはじめに\nGoogle Cloud の VPC Service Controls（VPC-SC）を enforced mode で運用している環境で、GitHub Actions による Terraform 実行が突然失敗するようになった経験はありませんか？\n","keywords":[],"articleBody":"⏺ 記事1: VPC Service ControlsでのGitHub Actions対応：エラーベース権限設定のベストプラクティス\nはじめに\nGoogle Cloud の VPC Service Controls（VPC-SC）を enforced mode で運用している環境で、GitHub Actions による Terraform 実行が突然失敗するようになった経験はありませんか？\n本記事では、VPC-SC 違反エラーの解決にエラーベース権限設定というアプローチを用いて、セキュリティを保ちながら効率的に権限を設定 する方法を解説します。\n問題の背景\nVPC Service Controls が dry-run mode から enforced mode に移行すると、今まで動いていた GitHub Actions ワークフローが以下のようなエラーで失敗するようになります：\nError 403: Request is prohibited by organization’s policy. vpcServiceControlsUniqueIdentifier: xxxxx\nこれは、GitHub Actions の Workload Identity Federation で使用するサービスアカウントが、VPC-SC で保護されたリソースにアクセスできなくなったためです。\nエラーベース権限設定とは\n従来のアプローチでは、事前に「必要そうな権限」をすべて付与することが多かったのですが、エラーベース権限設定では：\n最小限の権限でスタート 実際にエラーが発生したタイミングで権限を追加 エラーログから必要な権限を正確に特定 このアプローチにより、真に必要な権限のみを付与することができます。\n実践：エラーログの読み方\nVPC-SC違反が発生すると、Cloud Logging に詳細なエラーログが記録されます：\n{ “protoPayload”: { “serviceName”: “storage.googleapis.com”, “methodName”: “google.storage.buckets.testIamPermissions”, “authenticationInfo”: { “principalEmail”: “github-actions-plan@project.iam.gserviceaccount.com” } } }\nこのログから以下の情報を読み取れます：\n対象サービス: storage.googleapis.com 必要なメソッド: google.storage.buckets.testIamPermissions エラーの主体: GitHub Actions のサービスアカウント VPC-SC Ingress Policy の設定\nエラーログをもとに、ingress policy を設定します：\nresource “google_access_context_manager_service_perimeter_ingress_policy” “github_actions” { perimeter = var.service_perimeter_name\ningress_from { identities = [ \"serviceAccount:github-actions-plan@project.iam.gserviceaccount.com\", \"serviceAccount:github-actions-apply@project.iam.gserviceaccount.com\" ] sources { access_level = \"*\" # GitHub Actions の IP は動的 } } ingress_to { resources = [\"projects/123456789\"] operations { service_name = \"storage.googleapis.com\" method_selectors { method = \"google.storage.buckets.testIamPermissions\" } } } }\n段階的な権限追加の実例\nTerraform での一般的な権限追加パターン：\n初期設定（Terraform state 管理） operations { service_name = “storage.googleapis.com” method_selectors { method = “google.storage.objects.list” method = “google.storage.objects.get” method = “google.storage.buckets.get” } }\nエラー発生後の追加 operations { service_name = “storage.googleapis.com” method_selectors { method = “google.storage.objects.create” # state更新用 method = “google.storage.buckets.testIamPermissions” # 権限確認用 } }\nBigQuery リソース管理 operations { service_name = “bigquery.googleapis.com” method_selectors { permission = “bigquery.datasets.get” permission = “bigquery.datasets.create” permission = “bigquery.tables.create” } }\nベストプラクティス\nログ監視の自動化 VPC-SC違反を監視するクエリ例 gcloud logging read ' protoPayload.metadata.\"@type\"=“type.googleapis.com/google.cloud.audit.VpcServiceControlAuditMetadata” AND protoPayload.authenticationInfo.principalEmail:“github-actions” ’ –format=“json”\n権限の文書化 エラーベースで追加した権限は、なぜその権限が必要なのかをコメントで記録：\noperations { service_name = “bigquery.googleapis.com” method_selectors { # Terraform での dataset 存在確認に必要 permission = “bigquery.datasets.get” # BigQuery audit log sink の作成に必要 permission = “bigquery.datasets.create” } }\n定期的な権限見直し 使用されていない権限を定期的にチェック：\n過去30日の API 使用状況を確認 gcloud logging read ' protoPayload.serviceName=“bigquery.googleapis.com” AND protoPayload.authenticationInfo.principalEmail:“github-actions” AND timestamp\u003e=“2024-01-01” ’ –format=“table(protoPayload.methodName)”\nまとめ\nエラーベース権限設定は、VPC Service Controls 環境での権限管理において：\nセキュリティ向上: 最小権限の原則を実践 運用効率化: 不要な権限調査時間を削減 透明性確保: 権限付与の根拠が明確 GitHub Actions と VPC-SC の組み合わせでお困りの際は、ぜひこのアプローチを試してみてください。\n記事2: Google CloudサービスのVPC Service Controls対応状況：メソッド指定の罠と対策\nはじめに\nVPC Service Controls（VPC-SC）で ingress/egress policy を設定する際、サービスによってメソッド指定の対応状況が大きく異なることをご存知でしょうか？\n本記事では、実際に遭遇したエラーから学んだ、Google Cloud サービス別のメソッド指定対応状況と、それぞれの対策方法を詳しく解説します。\nVPC-SC でのメソッド指定の基本\nVPC-SC の ingress/egress policy では、以下の2つの方法でアクセス権限を指定できます：\nPermissions 指定 operations { service_name = “bigquery.googleapis.com” method_selectors { permission = “bigquery.datasets.get” permission = “bigquery.tables.create” } }\nMethods 指定 operations { service_name = “storage.googleapis.com” method_selectors { method = “google.storage.objects.get” method = “google.storage.buckets.list” } }\nサービス別対応状況一覧\n実際に検証した結果、サービスごとに対応状況が大きく異なることが判明しました：\nサービス 個別メソッド指定 対応形式 備考 storage.googleapis.com ✅ フルパス google.storage.objects.get bigquery.googleapis.com ✅ permissions/methods併用 用途により使い分け logging.googleapis.com ✅ 短縮形式 ConfigServiceV2.GetSink monitoring.googleapis.com ❌ * のみ 個別指定不可 secretmanager.googleapis.com ❌ * のみ 個別指定不可 datacatalog.googleapis.com ❌ * のみ 個別指定不可 実際のエラーパターンと対策\nパターン1: フルパス指定が必要なケース\nエラー例（Storage）: Error 400: METHOD ‘objects.get’ is not supported in storage.googleapis.com\n対策:\n❌ 短縮形式 method = “objects.get”\n✅ フルパス指定 method = “google.storage.objects.get”\nパターン2: 短縮形式でないとエラーになるケース\nエラー例（Logging）: Error 400: METHOD ‘google.logging.v2.ConfigServiceV2.GetSink’ is not supported in logging.googleapis.com\n対策:\n❌ フルパス method = “google.logging.v2.ConfigServiceV2.GetSink”\n✅ 短縮形式 method = “ConfigServiceV2.GetSink”\nパターン3: 個別指定が一切サポートされないケース\nエラー例（Monitoring）: Error 400: METHOD ‘NotificationChannelService.GetNotificationChannel’ is not supported in monitoring.googleapis.com\n対策:\n❌ 個別メソッド指定 method = “NotificationChannelService.GetNotificationChannel”\n✅ ワイルドカード使用 method = “*”\nBigQuery の特殊ケース\nBigQuery は permissions と methods の使い分けが重要です：\nPermissions を使用するケース\noperations { service_name = “bigquery.googleapis.com” method_selectors { # データセット・テーブル操作 permission = “bigquery.datasets.get” permission = “bigquery.tables.create” } }\nMethods を使用するケース\noperations { service_name = “bigquery.googleapis.com” method_selectors { # 特定の API 呼び出し method = “DatasetService.InsertDataset” method = “TableDataService.InsertAll” } }\nIAM 操作の罠\nBigQuery での IAM 操作は特に注意が必要です：\n❌ BigQuery サービス内でのIAM指定（エラーになる） operations { service_name = “bigquery.googleapis.com” method_selectors { permission = “bigquery.datasets.getIamPolicy” # サポート外 method = “google.iam.v1.IAMPolicy.GetIamPolicy” # サポート外 } }\n✅ 実際にはBigQueryの標準権限で処理される operations { service_name = “bigquery.googleapis.com” method_selectors { permission = “bigquery.datasets.get” permission = “bigquery.datasets.update” } }\n効率的な調査方法\nエラーメッセージからの推測 エラーメッセージのパターンで対応状況を推測：\nパターン1: フルパス不足 “METHOD ‘objects.get’ is not supported” → google.storage.objects.get を試す\nパターン2: フルパス過多 “METHOD ‘google.logging.v2.ConfigServiceV2.GetSink’ is not supported” → ConfigServiceV2.GetSink を試す\nパターン3: 個別指定不可 “METHOD ‘NotificationChannelService.GetNotificationChannel’ is not supported” → “*” を使用\n段階的テスト戦略 Step 1: 具体的メソッドを試す method = “SpecificMethod.Action”\nStep 2: 短縮形式を試す method = “Action”\nStep 3: ワイルドカードにフォールバック method = “*”\nドキュメント確認 Google Cloud のドキュメントで対応状況を確認：\nhttps://cloud.google.com/vpc-service-controls/docs/supported-services 各サービスの API リファレンス まとめとベストプラクティス\n対応状況の把握\nStorage/BigQuery: 詳細な制御が可能 Logging: 短縮形式で制御可能 Monitoring/SecretManager: ワイルドカードのみ 設定時の推奨手順\n具体的なメソッド指定から開始 エラーに応じて形式を調整 最終手段として * を使用 設定理由をコメントで文書化 コメント記載例\noperations { service_name = “monitoring.googleapis.com” method_selectors { method = “*” # 個別のメソッドは未サポート } }\nVPC Service Controls の複雑な仕様に惑わされず、段階的なアプローチで効率的に設定を進めていきましょう。\n記事3: Terraformプロバイダーから読み解く必要なGoogle Cloud権限設計\nはじめに\nTerraform で Google Cloud リソースを管理する際、「どの権限が本当に必要なのか？」という疑問を持ったことはありませんか？\n特に VPC Service Controls 環境では、過不足ない権限設定が重要になります。本記事では、Terraform のリソース定義から必要な Google Cloud 権限を逆算し、効率的な権限設計を行う方法を解説します。\n基本的な考え方\nTerraformリソース ≠ 必要権限 多くの場合、Terraform の1つのリソースを管理するために複数の Google Cloud 権限が必要になります：\nresource “google_bigquery_dataset” “example” { dataset_id = “example_dataset” location = “US” }\nこのシンプルなリソースでも、実際には以下の権限が必要：\nbigquery.datasets.get (状態確認) bigquery.datasets.create (作成) bigquery.datasets.update (更新) CRUD操作の分析 Terraform の操作フローから必要権限を導き出せます：\nTerraform操作 必要なGoogle Cloud権限 terraform plan Read権限 (*.get, *.list) terraform apply (作成) Create権限 (*.create) terraform apply (更新) Update権限 (*.update, *.patch) terraform destroy Delete権限 (*.delete) 実践例1: BigQuery Dataset管理\nTerraformリソース定義\nresource “google_bigquery_dataset” “analytics” { dataset_id = “analytics” friendly_name = “Analytics Dataset” description = “Dataset for analytics data” location = “US”\n# データセットアクセス制御 access { role = \"OWNER\" special_group = \"projectOwners\" } access { role = \"READER\" user_by_email = \"analyst@example.com\" } }\n必要権限の分析\n基本的なデータセット操作:\nVPC-SC Policy設定例 operations { service_name = “bigquery.googleapis.com” method_selectors { permission = “bigquery.datasets.get” # plan時の状態確認 permission = “bigquery.datasets.create” # 初回作成 permission = “bigquery.datasets.update” # 設定変更 } }\nアクセス制御の罠:\n多くの人が見落とすのが、access ブロックによる IAM 操作です：\n❌ 不十分な権限設定 permission = “bigquery.datasets.get” permission = “bigquery.datasets.create”\n✅ IAM操作も含めた完全な設定 permission = “bigquery.datasets.get” permission = “bigquery.datasets.create” permission = “bigquery.datasets.update”\naccess ブロックの変更には update 権限が必要 実践例2: BigQuery Dataset Access管理\nより複雑なケース\nresource “google_bigquery_dataset_access” “analyst_access” { dataset_id = google_bigquery_dataset.analytics.dataset_id role = “READER” user_by_email = “analyst@example.com” }\nresource “google_bigquery_dataset_access” “service_account_access” { dataset_id = google_bigquery_dataset.analytics.dataset_id role = “WRITER” user_by_email = “service-account@project.iam.gserviceaccount.com” }\n権限設計\noperations { service_name = “bigquery.googleapis.com” method_selectors { # データセット基本操作 permission = “bigquery.datasets.get” permission = “bigquery.datasets.update” # access変更に必要\n# IAM操作（dataset_access リソース用） # 注意: BigQueryのIAM操作は特殊で、標準的なIAM権限ではなく # BigQuery固有の権限で制御される } }\n実践例3: テーブル作成を含むケース\nTerraformリソース\nresource “google_bigquery_table” “user_events” { dataset_id = google_bigquery_dataset.analytics.dataset_id table_id = “user_events”\ntime_partitioning { type = \"DAY\" field = \"event_timestamp\" } schema = jsonencode([ { name = \"user_id\" type = \"STRING\" mode = \"REQUIRED\" }, { name = \"event_timestamp\" type = \"TIMESTAMP\" mode = \"REQUIRED\" } ]) }\n拡張された権限設計\noperations { service_name = “bigquery.googleapis.com” method_selectors { # データセット操作（依存関係で必要） permission = “bigquery.datasets.get”\n# テーブル操作 permission = \"bigquery.tables.get\" # plan時の確認 permission = \"bigquery.tables.create\" # 作成 permission = \"bigquery.tables.update\" # スキーマ変更等 permission = \"bigquery.tables.list\" # 依存関係確認 } }\n実践例4: ロギング設定を含む複合ケース\nTerraformリソース\nresource “google_logging_project_sink” “bigquery_sink” { name = “bigquery-audit-sink” destination = “bigquery.googleapis.com/projects/${var.project}/datasets/${google_bigquery_dataset.audit_logs.dataset_id}” filter = “resource.type=bigquery_resource” unique_writer_identity = true }\nresource “google_bigquery_dataset” “audit_logs” { dataset_id = “audit_logs” location = “US”\n# Sink からの書き込み用アクセス access { role = \"WRITER\" user_by_email = google_logging_project_sink.bigquery_sink.writer_identity } }\nマルチサービス権限設計\nBigQuery権限 operations { service_name = “bigquery.googleapis.com” method_selectors { permission = “bigquery.datasets.get” permission = “bigquery.datasets.create” permission = “bigquery.datasets.update” } }\nLogging権限 operations { service_name = “logging.googleapis.com” method_selectors { method = “ConfigServiceV2.GetSink” # sink状態確認 method = “ConfigServiceV2.CreateSink” # sink作成 method = “ConfigServiceV2.UpdateSink” # sink更新 } }\n権限設計のベストプラクティス\n段階的な権限付与戦略 Phase 1: 基本的な読み取り権限 permission = “bigquery.datasets.get” permission = “bigquery.tables.get”\nPhase 2: 作成権限（初回apply時に追加） permission = “bigquery.datasets.create” permission = “bigquery.tables.create”\nPhase 3: 更新権限（設定変更時に追加） permission = “bigquery.datasets.update” permission = “bigquery.tables.update”\n依存関係の理解 テーブル作成にはデータセット読み取り権限も必要 resource “google_bigquery_table” “example” { dataset_id = google_bigquery_dataset.example.dataset_id # この参照により必要 table_id = “example_table” }\n必要権限: - bigquery.datasets.get (依存関係確認) - bigquery.tables.create (テーブル作成) 環境別の権限調整 locals { # 開発環境：より多くの権限 dev_permissions = [ “bigquery.datasets.get”, “bigquery.datasets.create”, “bigquery.datasets.update”, “bigquery.datasets.delete”, # 開発では削除も許可 “bigquery.tables.get”, “bigquery.tables.create”, “bigquery.tables.update”, “bigquery.tables.delete” ]\n# 本番環境：最小権限 prod_permissions = [ \"bigquery.datasets.get\", \"bigquery.datasets.update\", # 設定変更のみ \"bigquery.tables.get\", \"bigquery.tables.update\" # スキーマ変更のみ ] }\n検証とモニタリング\n権限使用状況の確認 実際に使用された権限の確認 gcloud logging read ' protoPayload.serviceName=“bigquery.googleapis.com” AND protoPayload.authenticationInfo.principalEmail:“terraform-service-account” AND timestamp\u003e=TIMESTAMP_FROM_RFC3339(“2024-01-01T00:00:00Z”) ’ –format=“table(protoPayload.methodName, protoPayload.authorizationInfo.permission)”\n不要権限の特定 付与されているが使用されていない権限を特定 gcloud projects get-iam-policy PROJECT_ID –flatten=“bindings[].members” –filter=“bindings.members:terraform-service-account” –format=“table(bindings.role)”\nまとめ\nTerraform リソースから Google Cloud 権限を設計する際のポイント：\nリソース定義の詳細分析: 単純なリソースでも複数の権限が必要 依存関係の考慮: 参照されるリソースの読み取り権限も必要 段階的な権限付与: plan → apply → update の流れに沿って権限を追加 環境別の調整: 開発と本番で異なる権限レベルを設定 継続的な見直し: 実際の使用状況に基づく権限の最適化 適切な権限設計により、セキュリティを保ちながら効率的な Terraform 運用が実現できます。\n","wordCount":"4021","inLanguage":"ja","datePublished":"0001-01-01T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","author":{"@type":"Person","name":"トミー"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://firebird-techtalktech.com/post/blog/"},"publisher":{"@type":"Organization","name":"firebirdテクテクテクブログ","logo":{"@type":"ImageObject","url":"https://firebird-techtalktech.com/images/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://firebird-techtalktech.com/ accesskey=h title="Home (Alt + H)"><img src=https://firebird-techtalktech.com/images/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://firebird-techtalktech.com/categories/ title=カテゴリー><span>カテゴリー</span></a></li><li><a href=https://firebird-techtalktech.com/tags/ title=タグ><span>タグ</span></a></li><li><a href=https://firebird-techtalktech.com/archives/ title=アーカイブ><span>アーカイブ</span></a></li><li><a href=https://firebird-techtalktech.com/search/ title="検索 (Alt + /)" accesskey=/><span>検索</span></a></li></ul></nav></header><main class=main><header class=page-header><h1></h1></header><div class=two-pane-container><div class=main-content><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://firebird-techtalktech.com/>ホーム</a>&nbsp;»&nbsp;<a href=https://firebird-techtalktech.com/post/>Posts</a></div><h1 class="post-title entry-hint-parent"></h1><div class=post-meta>9 分&nbsp;·&nbsp;4021 文字&nbsp;·&nbsp;トミー&nbsp;|&nbsp;<a href=https://github.com/tmy310/blog/tree/main/hugo-sample/quickstart/content/post/blog.md rel="noopener noreferrer edit" target=_blank>編集を提案</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>目次</span></summary><div class=inner><nav id=TableOfContents></nav></div></details></div><div class=post-content><p>⏺ 記事1: VPC Service ControlsでのGitHub Actions対応：エラーベース権限設定のベストプラクティス</p><p>はじめに</p><p>Google Cloud の VPC Service Controls（VPC-SC）を enforced mode で運用している環境で、GitHub Actions による Terraform
実行が突然失敗するようになった経験はありませんか？</p><p>本記事では、VPC-SC 違反エラーの解決にエラーベース権限設定というアプローチを用いて、セキュリティを保ちながら効率的に権限を設定
する方法を解説します。</p><p>問題の背景</p><p>VPC Service Controls が dry-run mode から enforced mode に移行すると、今まで動いていた GitHub Actions
ワークフローが以下のようなエラーで失敗するようになります：</p><p>Error 403: Request is prohibited by organization&rsquo;s policy.
vpcServiceControlsUniqueIdentifier: xxxxx</p><p>これは、GitHub Actions の Workload Identity Federation で使用するサービスアカウントが、VPC-SC
で保護されたリソースにアクセスできなくなったためです。</p><p>エラーベース権限設定とは</p><p>従来のアプローチでは、事前に「必要そうな権限」をすべて付与することが多かったのですが、エラーベース権限設定では：</p><ol><li>最小限の権限でスタート</li><li>実際にエラーが発生したタイミングで権限を追加</li><li>エラーログから必要な権限を正確に特定</li></ol><p>このアプローチにより、真に必要な権限のみを付与することができます。</p><p>実践：エラーログの読み方</p><p>VPC-SC違反が発生すると、Cloud Logging に詳細なエラーログが記録されます：</p><p>{
&ldquo;protoPayload&rdquo;: {
&ldquo;serviceName&rdquo;: &ldquo;storage.googleapis.com&rdquo;,
&ldquo;methodName&rdquo;: &ldquo;google.storage.buckets.testIamPermissions&rdquo;,
&ldquo;authenticationInfo&rdquo;: {
&ldquo;principalEmail&rdquo;: &ldquo;<a href=mailto:github-actions-plan@project.iam.gserviceaccount.com>github-actions-plan@project.iam.gserviceaccount.com</a>&rdquo;
}
}
}</p><p>このログから以下の情報を読み取れます：</p><ul><li>対象サービス: storage.googleapis.com</li><li>必要なメソッド: google.storage.buckets.testIamPermissions</li><li>エラーの主体: GitHub Actions のサービスアカウント</li></ul><p>VPC-SC Ingress Policy の設定</p><p>エラーログをもとに、ingress policy を設定します：</p><p>resource &ldquo;google_access_context_manager_service_perimeter_ingress_policy&rdquo; &ldquo;github_actions&rdquo; {
perimeter = var.service_perimeter_name</p><pre><code>ingress_from {
  identities = [
    &quot;serviceAccount:github-actions-plan@project.iam.gserviceaccount.com&quot;,
    &quot;serviceAccount:github-actions-apply@project.iam.gserviceaccount.com&quot;
  ]
  sources {
    access_level = &quot;*&quot;  # GitHub Actions の IP は動的
  }
}

ingress_to {
  resources = [&quot;projects/123456789&quot;]
  operations {
    service_name = &quot;storage.googleapis.com&quot;
    method_selectors {
      method = &quot;google.storage.buckets.testIamPermissions&quot;
    }
  }
}
</code></pre><p>}</p><p>段階的な権限追加の実例</p><p>Terraform での一般的な権限追加パターン：</p><ol><li>初期設定（Terraform state 管理）</li></ol><p>operations {
service_name = &ldquo;storage.googleapis.com&rdquo;
method_selectors {
method = &ldquo;google.storage.objects.list&rdquo;
method = &ldquo;google.storage.objects.get&rdquo;
method = &ldquo;google.storage.buckets.get&rdquo;
}
}</p><ol start=2><li>エラー発生後の追加</li></ol><p>operations {
service_name = &ldquo;storage.googleapis.com&rdquo;
method_selectors {
method = &ldquo;google.storage.objects.create&rdquo; # state更新用
method = &ldquo;google.storage.buckets.testIamPermissions&rdquo; # 権限確認用
}
}</p><ol start=3><li>BigQuery リソース管理</li></ol><p>operations {
service_name = &ldquo;bigquery.googleapis.com&rdquo;
method_selectors {
permission = &ldquo;bigquery.datasets.get&rdquo;
permission = &ldquo;bigquery.datasets.create&rdquo;
permission = &ldquo;bigquery.tables.create&rdquo;
}
}</p><p>ベストプラクティス</p><ol><li>ログ監視の自動化</li></ol><h1 id=vpc-sc違反を監視するクエリ例>VPC-SC違反を監視するクエリ例<a hidden class=anchor aria-hidden=true href=#vpc-sc違反を監視するクエリ例>#</a></h1><p>gcloud logging read '
protoPayload.metadata."@type"=&ldquo;type.googleapis.com/google.cloud.audit.VpcServiceControlAuditMetadata&rdquo;
AND protoPayload.authenticationInfo.principalEmail:&ldquo;github-actions&rdquo;
&rsquo; &ndash;format=&ldquo;json&rdquo;</p><ol start=2><li>権限の文書化</li></ol><p>エラーベースで追加した権限は、なぜその権限が必要なのかをコメントで記録：</p><p>operations {
service_name = &ldquo;bigquery.googleapis.com&rdquo;
method_selectors {
# Terraform での dataset 存在確認に必要
permission = &ldquo;bigquery.datasets.get&rdquo;
# BigQuery audit log sink の作成に必要
permission = &ldquo;bigquery.datasets.create&rdquo;
}
}</p><ol start=3><li>定期的な権限見直し</li></ol><p>使用されていない権限を定期的にチェック：</p><h1 id=過去30日の-api-使用状況を確認>過去30日の API 使用状況を確認<a hidden class=anchor aria-hidden=true href=#過去30日の-api-使用状況を確認>#</a></h1><p>gcloud logging read '
protoPayload.serviceName=&ldquo;bigquery.googleapis.com&rdquo;
AND protoPayload.authenticationInfo.principalEmail:&ldquo;github-actions&rdquo;
AND timestamp>=&ldquo;2024-01-01&rdquo;
&rsquo; &ndash;format=&ldquo;table(protoPayload.methodName)&rdquo;</p><p>まとめ</p><p>エラーベース権限設定は、VPC Service Controls 環境での権限管理において：</p><ul><li>セキュリティ向上: 最小権限の原則を実践</li><li>運用効率化: 不要な権限調査時間を削減</li><li>透明性確保: 権限付与の根拠が明確</li></ul><p>GitHub Actions と VPC-SC の組み合わせでお困りの際は、ぜひこのアプローチを試してみてください。</p><hr><p>記事2: Google CloudサービスのVPC Service Controls対応状況：メソッド指定の罠と対策</p><p>はじめに</p><p>VPC Service Controls（VPC-SC）で ingress/egress policy
を設定する際、サービスによってメソッド指定の対応状況が大きく異なることをご存知でしょうか？</p><p>本記事では、実際に遭遇したエラーから学んだ、Google Cloud
サービス別のメソッド指定対応状況と、それぞれの対策方法を詳しく解説します。</p><p>VPC-SC でのメソッド指定の基本</p><p>VPC-SC の ingress/egress policy では、以下の2つの方法でアクセス権限を指定できます：</p><ol><li>Permissions 指定</li></ol><p>operations {
service_name = &ldquo;bigquery.googleapis.com&rdquo;
method_selectors {
permission = &ldquo;bigquery.datasets.get&rdquo;
permission = &ldquo;bigquery.tables.create&rdquo;
}
}</p><ol start=2><li>Methods 指定</li></ol><p>operations {
service_name = &ldquo;storage.googleapis.com&rdquo;
method_selectors {
method = &ldquo;google.storage.objects.get&rdquo;
method = &ldquo;google.storage.buckets.list&rdquo;
}
}</p><p>サービス別対応状況一覧</p><p>実際に検証した結果、サービスごとに対応状況が大きく異なることが判明しました：</p><table><thead><tr><th>サービス</th><th>個別メソッド指定</th><th>対応形式</th><th>備考</th></tr></thead><tbody><tr><td>storage.googleapis.com</td><td>✅</td><td>フルパス</td><td>google.storage.objects.get</td></tr><tr><td>bigquery.googleapis.com</td><td>✅</td><td>permissions/methods併用</td><td>用途により使い分け</td></tr><tr><td>logging.googleapis.com</td><td>✅</td><td>短縮形式</td><td>ConfigServiceV2.GetSink</td></tr><tr><td>monitoring.googleapis.com</td><td>❌</td><td>* のみ</td><td>個別指定不可</td></tr><tr><td>secretmanager.googleapis.com</td><td>❌</td><td>* のみ</td><td>個別指定不可</td></tr><tr><td>datacatalog.googleapis.com</td><td>❌</td><td>* のみ</td><td>個別指定不可</td></tr></tbody></table><p>実際のエラーパターンと対策</p><p>パターン1: フルパス指定が必要なケース</p><p>エラー例（Storage）:
Error 400: METHOD &lsquo;objects.get&rsquo; is not supported in storage.googleapis.com</p><p>対策:</p><h1 id=-短縮形式>❌ 短縮形式<a hidden class=anchor aria-hidden=true href=#-短縮形式>#</a></h1><p>method = &ldquo;objects.get&rdquo;</p><h1 id=-フルパス指定>✅ フルパス指定<a hidden class=anchor aria-hidden=true href=#-フルパス指定>#</a></h1><p>method = &ldquo;google.storage.objects.get&rdquo;</p><p>パターン2: 短縮形式でないとエラーになるケース</p><p>エラー例（Logging）:
Error 400: METHOD &lsquo;google.logging.v2.ConfigServiceV2.GetSink&rsquo; is not supported in logging.googleapis.com</p><p>対策:</p><h1 id=-フルパス>❌ フルパス<a hidden class=anchor aria-hidden=true href=#-フルパス>#</a></h1><p>method = &ldquo;google.logging.v2.ConfigServiceV2.GetSink&rdquo;</p><h1 id=-短縮形式-1>✅ 短縮形式<a hidden class=anchor aria-hidden=true href=#-短縮形式-1>#</a></h1><p>method = &ldquo;ConfigServiceV2.GetSink&rdquo;</p><p>パターン3: 個別指定が一切サポートされないケース</p><p>エラー例（Monitoring）:
Error 400: METHOD &lsquo;NotificationChannelService.GetNotificationChannel&rsquo; is not supported in monitoring.googleapis.com</p><p>対策:</p><h1 id=-個別メソッド指定>❌ 個別メソッド指定<a hidden class=anchor aria-hidden=true href=#-個別メソッド指定>#</a></h1><p>method = &ldquo;NotificationChannelService.GetNotificationChannel&rdquo;</p><h1 id=-ワイルドカード使用>✅ ワイルドカード使用<a hidden class=anchor aria-hidden=true href=#-ワイルドカード使用>#</a></h1><p>method = &ldquo;*&rdquo;</p><p>BigQuery の特殊ケース</p><p>BigQuery は permissions と methods の使い分けが重要です：</p><p>Permissions を使用するケース</p><p>operations {
service_name = &ldquo;bigquery.googleapis.com&rdquo;
method_selectors {
# データセット・テーブル操作
permission = &ldquo;bigquery.datasets.get&rdquo;
permission = &ldquo;bigquery.tables.create&rdquo;
}
}</p><p>Methods を使用するケース</p><p>operations {
service_name = &ldquo;bigquery.googleapis.com&rdquo;
method_selectors {
# 特定の API 呼び出し
method = &ldquo;DatasetService.InsertDataset&rdquo;
method = &ldquo;TableDataService.InsertAll&rdquo;
}
}</p><p>IAM 操作の罠</p><p>BigQuery での IAM 操作は特に注意が必要です：</p><h1 id=-bigquery-サービス内でのiam指定エラーになる>❌ BigQuery サービス内でのIAM指定（エラーになる）<a hidden class=anchor aria-hidden=true href=#-bigquery-サービス内でのiam指定エラーになる>#</a></h1><p>operations {
service_name = &ldquo;bigquery.googleapis.com&rdquo;
method_selectors {
permission = &ldquo;bigquery.datasets.getIamPolicy&rdquo; # サポート外
method = &ldquo;google.iam.v1.IAMPolicy.GetIamPolicy&rdquo; # サポート外
}
}</p><h1 id=-実際にはbigqueryの標準権限で処理される>✅ 実際にはBigQueryの標準権限で処理される<a hidden class=anchor aria-hidden=true href=#-実際にはbigqueryの標準権限で処理される>#</a></h1><p>operations {
service_name = &ldquo;bigquery.googleapis.com&rdquo;
method_selectors {
permission = &ldquo;bigquery.datasets.get&rdquo;
permission = &ldquo;bigquery.datasets.update&rdquo;
}
}</p><p>効率的な調査方法</p><ol><li>エラーメッセージからの推測</li></ol><p>エラーメッセージのパターンで対応状況を推測：</p><h1 id=パターン1-フルパス不足>パターン1: フルパス不足<a hidden class=anchor aria-hidden=true href=#パターン1-フルパス不足>#</a></h1><p>&ldquo;METHOD &lsquo;objects.get&rsquo; is not supported&rdquo;
→ google.storage.objects.get を試す</p><h1 id=パターン2-フルパス過多>パターン2: フルパス過多<a hidden class=anchor aria-hidden=true href=#パターン2-フルパス過多>#</a></h1><p>&ldquo;METHOD &lsquo;google.logging.v2.ConfigServiceV2.GetSink&rsquo; is not supported&rdquo;
→ ConfigServiceV2.GetSink を試す</p><h1 id=パターン3-個別指定不可>パターン3: 個別指定不可<a hidden class=anchor aria-hidden=true href=#パターン3-個別指定不可>#</a></h1><p>&ldquo;METHOD &lsquo;NotificationChannelService.GetNotificationChannel&rsquo; is not supported&rdquo;
→ &ldquo;*&rdquo; を使用</p><ol start=2><li>段階的テスト戦略</li></ol><h1 id=step-1-具体的メソッドを試す>Step 1: 具体的メソッドを試す<a hidden class=anchor aria-hidden=true href=#step-1-具体的メソッドを試す>#</a></h1><p>method = &ldquo;SpecificMethod.Action&rdquo;</p><h1 id=step-2-短縮形式を試す>Step 2: 短縮形式を試す<a hidden class=anchor aria-hidden=true href=#step-2-短縮形式を試す>#</a></h1><p>method = &ldquo;Action&rdquo;</p><h1 id=step-3-ワイルドカードにフォールバック>Step 3: ワイルドカードにフォールバック<a hidden class=anchor aria-hidden=true href=#step-3-ワイルドカードにフォールバック>#</a></h1><p>method = &ldquo;*&rdquo;</p><ol start=3><li>ドキュメント確認</li></ol><p>Google Cloud のドキュメントで対応状況を確認：</p><ul><li><a href=https://cloud.google.com/vpc-service-controls/docs/supported-services>https://cloud.google.com/vpc-service-controls/docs/supported-services</a></li><li>各サービスの API リファレンス</li></ul><p>まとめとベストプラクティス</p><p>対応状況の把握</p><ol><li>Storage/BigQuery: 詳細な制御が可能</li><li>Logging: 短縮形式で制御可能</li><li>Monitoring/SecretManager: ワイルドカードのみ</li></ol><p>設定時の推奨手順</p><ol><li>具体的なメソッド指定から開始</li><li>エラーに応じて形式を調整</li><li>最終手段として * を使用</li><li>設定理由をコメントで文書化</li></ol><p>コメント記載例</p><p>operations {
service_name = &ldquo;monitoring.googleapis.com&rdquo;
method_selectors {
method = &ldquo;*&rdquo; # 個別のメソッドは未サポート
}
}</p><p>VPC Service Controls の複雑な仕様に惑わされず、段階的なアプローチで効率的に設定を進めていきましょう。</p><hr><p>記事3: Terraformプロバイダーから読み解く必要なGoogle Cloud権限設計</p><p>はじめに</p><p>Terraform で Google Cloud リソースを管理する際、「どの権限が本当に必要なのか？」という疑問を持ったことはありませんか？</p><p>特に VPC Service Controls 環境では、過不足ない権限設定が重要になります。本記事では、Terraform のリソース定義から必要な Google
Cloud 権限を逆算し、効率的な権限設計を行う方法を解説します。</p><p>基本的な考え方</p><ol><li>Terraformリソース ≠ 必要権限</li></ol><p>多くの場合、Terraform の1つのリソースを管理するために複数の Google Cloud 権限が必要になります：</p><p>resource &ldquo;google_bigquery_dataset&rdquo; &ldquo;example&rdquo; {
dataset_id = &ldquo;example_dataset&rdquo;
location = &ldquo;US&rdquo;
}</p><p>このシンプルなリソースでも、実際には以下の権限が必要：</p><ul><li>bigquery.datasets.get (状態確認)</li><li>bigquery.datasets.create (作成)</li><li>bigquery.datasets.update (更新)</li></ul><ol start=2><li>CRUD操作の分析</li></ol><p>Terraform の操作フローから必要権限を導き出せます：</p><table><thead><tr><th>Terraform操作</th><th>必要なGoogle Cloud権限</th></tr></thead><tbody><tr><td>terraform plan</td><td>Read権限 (*.get, *.list)</td></tr><tr><td>terraform apply (作成)</td><td>Create権限 (*.create)</td></tr><tr><td>terraform apply (更新)</td><td>Update権限 (*.update, *.patch)</td></tr><tr><td>terraform destroy</td><td>Delete権限 (*.delete)</td></tr></tbody></table><p>実践例1: BigQuery Dataset管理</p><p>Terraformリソース定義</p><p>resource &ldquo;google_bigquery_dataset&rdquo; &ldquo;analytics&rdquo; {
dataset_id = &ldquo;analytics&rdquo;
friendly_name = &ldquo;Analytics Dataset&rdquo;
description = &ldquo;Dataset for analytics data&rdquo;
location = &ldquo;US&rdquo;</p><pre><code># データセットアクセス制御
access {
  role          = &quot;OWNER&quot;
  special_group = &quot;projectOwners&quot;
}

access {
  role         = &quot;READER&quot;
  user_by_email = &quot;analyst@example.com&quot;
}
</code></pre><p>}</p><p>必要権限の分析</p><p>基本的なデータセット操作:</p><h1 id=vpc-sc-policy設定例>VPC-SC Policy設定例<a hidden class=anchor aria-hidden=true href=#vpc-sc-policy設定例>#</a></h1><p>operations {
service_name = &ldquo;bigquery.googleapis.com&rdquo;
method_selectors {
permission = &ldquo;bigquery.datasets.get&rdquo; # plan時の状態確認
permission = &ldquo;bigquery.datasets.create&rdquo; # 初回作成
permission = &ldquo;bigquery.datasets.update&rdquo; # 設定変更
}
}</p><p>アクセス制御の罠:</p><p>多くの人が見落とすのが、access ブロックによる IAM 操作です：</p><h1 id=-不十分な権限設定>❌ 不十分な権限設定<a hidden class=anchor aria-hidden=true href=#-不十分な権限設定>#</a></h1><p>permission = &ldquo;bigquery.datasets.get&rdquo;
permission = &ldquo;bigquery.datasets.create&rdquo;</p><h1 id=-iam操作も含めた完全な設定>✅ IAM操作も含めた完全な設定<a hidden class=anchor aria-hidden=true href=#-iam操作も含めた完全な設定>#</a></h1><p>permission = &ldquo;bigquery.datasets.get&rdquo;
permission = &ldquo;bigquery.datasets.create&rdquo;
permission = &ldquo;bigquery.datasets.update&rdquo;</p><h1 id=access-ブロックの変更には-update-権限が必要>access ブロックの変更には update 権限が必要<a hidden class=anchor aria-hidden=true href=#access-ブロックの変更には-update-権限が必要>#</a></h1><p>実践例2: BigQuery Dataset Access管理</p><p>より複雑なケース</p><p>resource &ldquo;google_bigquery_dataset_access&rdquo; &ldquo;analyst_access&rdquo; {
dataset_id = google_bigquery_dataset.analytics.dataset_id
role = &ldquo;READER&rdquo;
user_by_email = &ldquo;<a href=mailto:analyst@example.com>analyst@example.com</a>&rdquo;
}</p><p>resource &ldquo;google_bigquery_dataset_access&rdquo; &ldquo;service_account_access&rdquo; {
dataset_id = google_bigquery_dataset.analytics.dataset_id
role = &ldquo;WRITER&rdquo;
user_by_email = &ldquo;<a href=mailto:service-account@project.iam.gserviceaccount.com>service-account@project.iam.gserviceaccount.com</a>&rdquo;
}</p><p>権限設計</p><p>operations {
service_name = &ldquo;bigquery.googleapis.com&rdquo;
method_selectors {
# データセット基本操作
permission = &ldquo;bigquery.datasets.get&rdquo;
permission = &ldquo;bigquery.datasets.update&rdquo; # access変更に必要</p><pre><code>  # IAM操作（dataset_access リソース用）
  # 注意: BigQueryのIAM操作は特殊で、標準的なIAM権限ではなく
  # BigQuery固有の権限で制御される
}
</code></pre><p>}</p><p>実践例3: テーブル作成を含むケース</p><p>Terraformリソース</p><p>resource &ldquo;google_bigquery_table&rdquo; &ldquo;user_events&rdquo; {
dataset_id = google_bigquery_dataset.analytics.dataset_id
table_id = &ldquo;user_events&rdquo;</p><pre><code>time_partitioning {
  type  = &quot;DAY&quot;
  field = &quot;event_timestamp&quot;
}

schema = jsonencode([
  {
    name = &quot;user_id&quot;
    type = &quot;STRING&quot;
    mode = &quot;REQUIRED&quot;
  },
  {
    name = &quot;event_timestamp&quot;
    type = &quot;TIMESTAMP&quot;
    mode = &quot;REQUIRED&quot;
  }
])
</code></pre><p>}</p><p>拡張された権限設計</p><p>operations {
service_name = &ldquo;bigquery.googleapis.com&rdquo;
method_selectors {
# データセット操作（依存関係で必要）
permission = &ldquo;bigquery.datasets.get&rdquo;</p><pre><code>  # テーブル操作
  permission = &quot;bigquery.tables.get&quot;      # plan時の確認
  permission = &quot;bigquery.tables.create&quot;   # 作成
  permission = &quot;bigquery.tables.update&quot;   # スキーマ変更等
  permission = &quot;bigquery.tables.list&quot;     # 依存関係確認
}
</code></pre><p>}</p><p>実践例4: ロギング設定を含む複合ケース</p><p>Terraformリソース</p><p>resource &ldquo;google_logging_project_sink&rdquo; &ldquo;bigquery_sink&rdquo; {
name = &ldquo;bigquery-audit-sink&rdquo;
destination =
&ldquo;bigquery.googleapis.com/projects/${var.project}/datasets/${google_bigquery_dataset.audit_logs.dataset_id}&rdquo;
filter = &ldquo;resource.type=bigquery_resource&rdquo;
unique_writer_identity = true
}</p><p>resource &ldquo;google_bigquery_dataset&rdquo; &ldquo;audit_logs&rdquo; {
dataset_id = &ldquo;audit_logs&rdquo;
location = &ldquo;US&rdquo;</p><pre><code># Sink からの書き込み用アクセス
access {
  role          = &quot;WRITER&quot;
  user_by_email = google_logging_project_sink.bigquery_sink.writer_identity
}
</code></pre><p>}</p><p>マルチサービス権限設計</p><h1 id=bigquery権限>BigQuery権限<a hidden class=anchor aria-hidden=true href=#bigquery権限>#</a></h1><p>operations {
service_name = &ldquo;bigquery.googleapis.com&rdquo;
method_selectors {
permission = &ldquo;bigquery.datasets.get&rdquo;
permission = &ldquo;bigquery.datasets.create&rdquo;
permission = &ldquo;bigquery.datasets.update&rdquo;
}
}</p><h1 id=logging権限>Logging権限<a hidden class=anchor aria-hidden=true href=#logging権限>#</a></h1><p>operations {
service_name = &ldquo;logging.googleapis.com&rdquo;
method_selectors {
method = &ldquo;ConfigServiceV2.GetSink&rdquo; # sink状態確認
method = &ldquo;ConfigServiceV2.CreateSink&rdquo; # sink作成
method = &ldquo;ConfigServiceV2.UpdateSink&rdquo; # sink更新
}
}</p><p>権限設計のベストプラクティス</p><ol><li>段階的な権限付与戦略</li></ol><h1 id=phase-1-基本的な読み取り権限>Phase 1: 基本的な読み取り権限<a hidden class=anchor aria-hidden=true href=#phase-1-基本的な読み取り権限>#</a></h1><p>permission = &ldquo;bigquery.datasets.get&rdquo;
permission = &ldquo;bigquery.tables.get&rdquo;</p><h1 id=phase-2-作成権限初回apply時に追加>Phase 2: 作成権限（初回apply時に追加）<a hidden class=anchor aria-hidden=true href=#phase-2-作成権限初回apply時に追加>#</a></h1><p>permission = &ldquo;bigquery.datasets.create&rdquo;
permission = &ldquo;bigquery.tables.create&rdquo;</p><h1 id=phase-3-更新権限設定変更時に追加>Phase 3: 更新権限（設定変更時に追加）<a hidden class=anchor aria-hidden=true href=#phase-3-更新権限設定変更時に追加>#</a></h1><p>permission = &ldquo;bigquery.datasets.update&rdquo;
permission = &ldquo;bigquery.tables.update&rdquo;</p><ol start=2><li>依存関係の理解</li></ol><h1 id=テーブル作成にはデータセット読み取り権限も必要>テーブル作成にはデータセット読み取り権限も必要<a hidden class=anchor aria-hidden=true href=#テーブル作成にはデータセット読み取り権限も必要>#</a></h1><p>resource &ldquo;google_bigquery_table&rdquo; &ldquo;example&rdquo; {
dataset_id = google_bigquery_dataset.example.dataset_id # この参照により必要
table_id = &ldquo;example_table&rdquo;
}</p><h1 id=必要権限>必要権限:<a hidden class=anchor aria-hidden=true href=#必要権限>#</a></h1><h1 id=--bigquerydatasetsget-依存関係確認>- bigquery.datasets.get (依存関係確認)<a hidden class=anchor aria-hidden=true href=#--bigquerydatasetsget-依存関係確認>#</a></h1><h1 id=--bigquerytablescreate-テーブル作成>- bigquery.tables.create (テーブル作成)<a hidden class=anchor aria-hidden=true href=#--bigquerytablescreate-テーブル作成>#</a></h1><ol start=3><li>環境別の権限調整</li></ol><p>locals {
# 開発環境：より多くの権限
dev_permissions = [
&ldquo;bigquery.datasets.get&rdquo;,
&ldquo;bigquery.datasets.create&rdquo;,
&ldquo;bigquery.datasets.update&rdquo;,
&ldquo;bigquery.datasets.delete&rdquo;, # 開発では削除も許可
&ldquo;bigquery.tables.get&rdquo;,
&ldquo;bigquery.tables.create&rdquo;,
&ldquo;bigquery.tables.update&rdquo;,
&ldquo;bigquery.tables.delete&rdquo;
]</p><pre><code># 本番環境：最小権限
prod_permissions = [
  &quot;bigquery.datasets.get&quot;,
  &quot;bigquery.datasets.update&quot;,  # 設定変更のみ
  &quot;bigquery.tables.get&quot;,
  &quot;bigquery.tables.update&quot;     # スキーマ変更のみ
]
</code></pre><p>}</p><p>検証とモニタリング</p><ol><li>権限使用状況の確認</li></ol><h1 id=実際に使用された権限の確認>実際に使用された権限の確認<a hidden class=anchor aria-hidden=true href=#実際に使用された権限の確認>#</a></h1><p>gcloud logging read '
protoPayload.serviceName=&ldquo;bigquery.googleapis.com&rdquo;
AND protoPayload.authenticationInfo.principalEmail:&ldquo;terraform-service-account&rdquo;
AND timestamp>=TIMESTAMP_FROM_RFC3339(&ldquo;2024-01-01T00:00:00Z&rdquo;)
&rsquo; &ndash;format=&ldquo;table(protoPayload.methodName, protoPayload.authorizationInfo.permission)&rdquo;</p><ol start=2><li>不要権限の特定</li></ol><h1 id=付与されているが使用されていない権限を特定>付与されているが使用されていない権限を特定<a hidden class=anchor aria-hidden=true href=#付与されているが使用されていない権限を特定>#</a></h1><p>gcloud projects get-iam-policy PROJECT_ID<br>&ndash;flatten=&ldquo;bindings[].members&rdquo;<br>&ndash;filter=&ldquo;bindings.members:terraform-service-account&rdquo;<br>&ndash;format=&ldquo;table(bindings.role)&rdquo;</p><p>まとめ</p><p>Terraform リソースから Google Cloud 権限を設計する際のポイント：</p><ol><li>リソース定義の詳細分析: 単純なリソースでも複数の権限が必要</li><li>依存関係の考慮: 参照されるリソースの読み取り権限も必要</li><li>段階的な権限付与: plan → apply → update の流れに沿って権限を追加</li><li>環境別の調整: 開発と本番で異なる権限レベルを設定</li><li>継続的な見直し: 実際の使用状況に基づく権限の最適化</li></ol><p>適切な権限設計により、セキュリティを保ちながら効率的な Terraform 運用が実現できます。</p></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://firebird-techtalktech.com/post/blog-copy/><span class=title>« 前へ</span><br><span></span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share  on x" href="https://x.com/intent/tweet/?text=&amp;url=https%3a%2f%2ffirebird-techtalktech.com%2fpost%2fblog%2f&amp;hashtags="><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share  on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2ffirebird-techtalktech.com%2fpost%2fblog%2f&amp;title=&amp;summary=&amp;source=https%3a%2f%2ffirebird-techtalktech.com%2fpost%2fblog%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share  on reddit" href="https://reddit.com/submit?url=https%3a%2f%2ffirebird-techtalktech.com%2fpost%2fblog%2f&title="><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share  on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2ffirebird-techtalktech.com%2fpost%2fblog%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share  on whatsapp" href="https://api.whatsapp.com/send?text=%20-%20https%3a%2f%2ffirebird-techtalktech.com%2fpost%2fblog%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share  on telegram" href="https://telegram.me/share/url?text=&amp;url=https%3a%2f%2ffirebird-techtalktech.com%2fpost%2fblog%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share  on ycombinator" href="https://news.ycombinator.com/submitlink?t=&u=https%3a%2f%2ffirebird-techtalktech.com%2fpost%2fblog%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></div><aside class=sidebar><div class="sidebar-widget profile-widget"><h3>プロフィール</h3><div class=profile-content><div class=profile-avatar><img src=https://firebird-techtalktech.com/images/apple-touch-icon.png alt=トミー></div><div class=profile-info><h4>トミー</h4><p>技術ネタ、趣味や備忘録などを書いているブログです</p><div class=profile-stats><span class=post-count>記事数: 26</span></div></div></div></div><div class="sidebar-widget popular-widget"><h3>📝 最新記事</h3><ul class=popular-list><li><a href=https://firebird-techtalktech.com/post/terraform-2025-08-31-iac%E8%B6%85%E5%85%A5%E9%96%8030%E6%97%A5%E3%81%A7aws-cloudformation%E3%81%A8terraform%E3%82%92%E3%83%9E%E3%82%B9%E3%82%BF%E3%83%BC%E3%81%99%E3%82%8B%E3%83%AD%E3%83%BC%E3%83%89%E3%83%9E%E3%83%83/><span class=popular-title>🏗️ 【IaC超入門】30日でAWS CloudFormationとTerraformをマ …</span>
<span class=popular-date>08/31</span></a></li><li><a href=https://firebird-techtalktech.com/post/terraform-2025-08-31-terraformdefault_tags%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E3%81%AE%E3%82%BF%E3%82%B0%E4%BB%98%E3%81%91%E9%81%8B%E7%94%A8%E3%82%92%E6%A5%BD%E3%81%AB%E3%81%97%E3%82%88%E3%81%86/><span class=popular-title>🏗️ 【Terraform】default_tagsを使ってリソースのタグ付け運用を楽にし …</span>
<span class=popular-date>08/31</span></a></li><li><a href=https://firebird-techtalktech.com/post/terraform-2025-08-31--deploying-a-highly-scalable--available-django-app/><span class=popular-title>🏗️ 🚀 Deploying a Highly Scalable & Available …</span>
<span class=popular-date>08/31</span></a></li><li><a href=https://firebird-techtalktech.com/post/terraform-2025-08-31-aws-s3--google-cloud-storage%E3%81%8B%E3%82%89%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88%E3%83%89%E3%83%AA%E3%83%96%E3%83%B3%E3%81%A7trocco%E3%82%92%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B/><span class=popular-title>🏗️ AWS S3 / Google Cloud Storageから、イベントドリブン …</span>
<span class=popular-date>08/31</span></a></li><li><a href=https://firebird-techtalktech.com/post/terraform-2025-08-31-building-a-production-ready-terraform-project-with/><span class=popular-title>🏗️ Building a Production-Ready Terraform …</span>
<span class=popular-date>08/31</span></a></li></ul></div><div class="sidebar-widget categories-widget"><h3>📁 カテゴリー</h3><ul class=category-list><li><a href=/categories/terraform>Terraform (17)</a></li><li><a href=/categories/%E3%81%8A%E7%9F%A5%E3%82%89%E3%81%9B>お知らせ (1)</a></li><li><a href=/categories/%E6%8A%80%E8%A1%93>技術 (3)</a></li><li><a href=/categories/%E6%97%85%E8%A1%8C>旅行 (1)</a></li><li><a href=/categories/%E6%97%85%E8%A1%8C%E8%A8%98>旅行記 (2)</a></li></ul></div><div class="sidebar-widget tags-widget"><h3>🏷️ タグ</h3><div class=tag-cloud><a href=/tags/aws class=tag-link style=font-size:1.6rem>aws
</a><a href=/tags/cloud class=tag-link style=font-size:1.1rem>cloud
</a><a href=/tags/devops class=tag-link style=font-size:1.5rem>devops
</a><a href=/tags/iac class=tag-link style=font-size:2.5rem>iac
</a><a href=/tags/infrastructure class=tag-link style=font-size:2.5rem>infrastructure
</a><a href=/tags/terraform class=tag-link style=font-size:2.5rem>terraform</a></div></div><div class="sidebar-widget search-widget"><h3>🔍 検索</h3><div class=search-container><input type=text id=searchInput placeholder=記事を検索...>
<button type=button onclick='window.location.href="/search/?q="+document.getElementById("searchInput").value'>検索</button></div></div><div class="sidebar-widget links-widget"><h3>🔗 リンク</h3><ul class=links-list><li><a href=/about/ target=_blank>このブログについて</a></li><li><a href=/contact/ target=_blank>お問い合わせ</a></li><li><a href=/privacy/ target=_blank>プライバシーポリシー</a></li><li><a href=/sitemap-page/ target=_blank>サイトマップ</a></li><li><a href=https://twitter.com/firebird19245 target=_blank rel=noopener>Twitter</a></li></ul></div></aside></div></main><footer class=footer><span>&copy; 2025 <a href=https://firebird-techtalktech.com/>firebirdテクテクテクブログ</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="コピー";function s(){t.innerHTML="コピーされました!",setTimeout(()=>{t.innerHTML="コピー"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>